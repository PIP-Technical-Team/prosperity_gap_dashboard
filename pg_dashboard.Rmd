---
title: "Prosperity Gap Dashboard"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
    theme: paper
runtime: shiny
resource_files:
- data/dt_country.rds
- data/dt_imputed.rds
- data/dt_lineup.rds
- data/dt_region.rds
- data/headcounts_lineup.rds
- data/headcounts_survey.rds
- data/countries_lookup.rds
- data/countries_lookup.rds
- data/dt_country.rds
- data/dt_imputed.rds
- data/dt_lineup.rds
- data/dt_region.rds
- data/headcounts_lineup.rds
- data/headcounts_survey.rds
- data/countries_lookup.rds
- data/dt_country.rds
- data/dt_imputed.rds
- data/dt_lineup.rds
- data/dt_region.rds
- data/headcounts_lineup.rds
- data/headcounts_survey.rds
- data/countries_lookup.rds
- data/dt_country.rds
- data/dt_imputed.rds
- data/dt_lineup.rds
- data/dt_region.rds
- data/headcounts_lineup.rds
- data/headcounts_survey.rds
- data/countries_lookup.rds
- data/dt_country.rds
- data/dt_imputed.rds
- data/dt_lineup.rds
- data/dt_region.rds
- data/headcounts_lineup.rds
- data/headcounts_survey.rds
---

```{r}
htmltools::includeHTML("custom_header.html")
```


```{r setup-packages, include=FALSE}
library("tidyverse")
library("rlang")
library("here")
library("data.table")
library("plotly")
library("flexdashboard")  
library("joyn")
library("gghighlight")
library("DT")
library("RColorBrewer")
library("highcharter")
library("ggrepel")
library("ggtext")
library("zoo")
library("collapse")
```


```{r data-prep, include=FALSE}
# DATA  ----

# Upload objects ----------------------------------------------------------------
dt_country <- readRDS(
  file   = here::here(
    "data", 
    "dt_country.rds"
  ) 
)
dt_region <- readRDS(
  file   = here::here(
    "data", 
    "dt_region.rds"
  ) 
)
dt_lineup <- readRDS(
  file   = here::here(
    "data", 
    "dt_lineup.rds"
  ) 
)
countries_lookup <- readRDS(
  file   = here::here(
    "data", 
    "countries_lookup.rds"
  ) 
)
# headcount data
dt_headcount_survey <- readRDS(
  file = here::here(
    "data", 
    "headcounts_survey.rds"
  )
)
dt_headcount_lineup <- readRDS(
  file = here::here(
    "data", 
    "headcounts_lineup.rds"
  )
)
dt_imputed <- readRDS(
  file = here::here(
    "data", 
    "dt_imputed.rds"
  )
)
```


```{r load-functions, include=FALSE}
# Source text to include on plots
source_text <- paste("Kraay ⓡ al. (2023) updated based on Poverty and Inequality Platform (version 20230919_2017)")

title_function <- function(ind){
  
  title_lookup <- c("Mean", 
                    "Mean_b40", 
                    "PG", 
                    "Inequality", 
                    "PG_growth", 
                    "Inequality_growth", 
                    "Mean_growth", 
                    "Mean_b40_growth", 
                    "Headcount215",
                    "Headcount365",
                    "Headcount685"
  )
  
  title_use_vec <- c(
    "Mean (daily per capita, 2017 $PPP)", 
    "Mean of bottom 40 (daily pc, 2017 $PPP)",
    "Prosperity Gap", 
    "(PG) Inequality", 
    "Growth in Prosperity Gap", 
    "Growth in Mean (daily p.c., 2017 $PPP)", 
    "Growth in Mean of bottom 40 (daily pc, 2017 $PPP)",
    "Growth in (PG) Inequality", 
    "Poverty headcount - $2.15 daily p.c.",
    "Poverty headcount - $3.65 daily p.c.", 
    "Poverty headcount - $6.85 daily p.c."
  )
  
  use_title <- title_use_vec[
    which(
      title_lookup %chin% ind
    )
  ]
  
  return(use_title)
  
}

title_function2 <- function(ind){
  
  title_lookup <- c(
    "Prosperity Gap",
    "Mean", 
    "Mean - Bottom 40", 
    "(PG) Inequality", 
    "Growth - Prosperity Gap", 
    "Growth - Mean", 
    "Growth - Mean Bottom 40",
    "Growth - (PG) Inequality", 
    "Poverty headcount - $2.15",
    "Poverty headcount - $3.65",
    "Poverty headcount - $6.85"
  )
  
  title_use_vec <- c(
    "Prosperity Gap",
    "Mean (daily p.c., 2017 $PPP)", 
    "Mean of bottom 40 (daily p.c.)", 
    "(PG) Inequality", 
    "Growth in Prosperity Gap", 
    "Growth in Mean (daily pc, 2017 $PPP)", 
    "Growth in Mean of bottom 40 (daily pc, 2017 $PPP)",
    "Growth in (PG) Inequality", 
    "Poverty headcount - $2.15 (daily p.c.)",
    "Poverty headcount - $3.65 (daily p.c.)", 
    "Poverty headcount - $6.85 (daily p.c.)"
  )
  
  use_title <- title_use_vec[
    which(
      title_lookup %chin% ind
    )
  ]
  
  return(use_title)
  
}

title_function_y_2 <- function(ind){
  
  title_lookup <- c(
    "Prosperity Gap",
    "Mean", 
    "Mean - Bottom 40", 
    "(PG) Inequality", 
    "Growth - Prosperity Gap", 
    "Growth - Mean", 
    "Growth - Mean Bottom 40",
    "Growth - (PG) Inequality", 
    "Poverty headcount - $2.15",
    "Poverty headcount - $3.65",
    "Poverty headcount - $6.85"
  )
  
  title_use_vec <- c(
    "Prosperity Gap \n (Lower values correspond to better outcomes)",
    "Mean (daily p.c., 2017 $PPP)", 
    "Mean of bottom 40 (daily p.c.)", 
    "(PG) Inequality", 
    "Growth in Prosperity Gap", 
    "Growth in Mean (daily pc, 2017 $PPP)", 
    "Growth in Mean of bottom 40 (daily pc, 2017 $PPP)",
    "Growth in (PG) Inequality", 
    "Poverty headcount - $2.15 (daily p.c.)",
    "Poverty headcount - $3.65 (daily p.c.)", 
    "Poverty headcount - $6.85 (daily p.c.)"
  )
  
  use_title <- title_use_vec[
    which(
      title_lookup %chin% ind
    )
  ]
  
  return(use_title)
  
}



title_function_y <- function(ind){
  
  title_lookup <- c("Mean", 
                    "Mean_b40", 
                    "PG", 
                    "Inequality", 
                    "PG_growth", 
                    "Inequality_growth", 
                    "Mean_growth", 
                    "Mean_b40_growth", 
                    "Headcount215",
                    "Headcount365",
                    "Headcount685"
  )
  
  title_use_vec <- c(
    "Mean (daily per capita, 2017 $PPP)", 
    "Mean of bottom 40 (daily pc, 2017 $PPP)",
    "Prosperity Gap \n (Lower values correspond to better outcomes)", 
    "(PG) Inequality", 
    "Growth in Prosperity Gap", 
    "Growth in Mean (daily p.c., 2017 $PPP)", 
    "Growth in Mean of bottom 40 (daily pc, 2017 $PPP)",
    "Growth in (PG) Inequality", 
    "Poverty headcount - $2.15 daily p.c.",
    "Poverty headcount - $3.65 daily p.c.", 
    "Poverty headcount - $6.85 daily p.c."
  )
  
  use_title <- title_use_vec[
    which(
      title_lookup %chin% ind
    )
  ]
  
  return(use_title)
  
}
              

# Add Download button
downloadButtonRmd <- function (outputId, label = "Download", class = NULL, ...)  {
     tags$a(id = outputId, class = paste("btn btn-default shiny-download-link", 
        class), href = "", target = "_blank", download = NA, 
        icon("download"), label, ...)
 }

# create_data_imputed_by_countries_two_years_pg(dt = dt_country, countries_selected = countries_selected, year1_selected = 1998, year2_selected = 2005, indicator = indicator)
create_data_imputed_by_countries_two_years_pg <- function(
    dt = dt_country, 
    countries_selected  = c("South Africa", "Colombia", "United States"), 
    year1_selected      = 1998, 
    year2_selected      = 2005,
    indicator           = c("Prosperity Gap"), 
    window_length       = 2 
){
  dt_use <- copy(dt)
  
  # Change the indicator values
  if(!indicator %chin% c("PG", "Mean_b40", "Mean", "Inequality")){
    
    indicator <- switch(
      indicator, 
      "Prosperity Gap"   = "PG", 
      "Mean - Bottom 40" = "Mean_b40", 
      "Mean"             = "Mean", 
      "Inequality"       = "Inequality"
    )
  }
  
  dt1 <- dt_use[
    Year == year1_selected
  ]
  
  setnames(
    dt1, 
    old = c(indicator,    "ImputeDistance",  "ImputeDirection"), 
    new = c("Indicator1", "ImputeYears1",    "Impute_Forward1")
  )
  dt1 <- dt1[, .(Country_name, Year, Indicator1, ImputeYears1, Impute_Forward1, Survey_comparability)]
  
  dt2 <- dt_use[
    Year == year2_selected
  ]
  
  setnames(
    dt2,  
    old = c(indicator,    "ImputeDistance",  "ImputeDirection"), 
    new = c("Indicator2", "ImputeYears2",    "Impute_Forward2")
  )
  dt2 <- dt2[, .(Country_name, Year, Indicator2, ImputeYears2, Impute_Forward2, Region_name, Survey_comparability)]
  
  # Join the two years
  dt_use <- joyn::merge(
    dt1, 
    dt2, 
    keep = "inner", 
    match_type = "1:1", 
    by = c("Country_name", "Survey_comparability")
  )
  
  # Find the change in indicator
  dt_use[, report:=NULL]
  dt_use[, Change := Indicator2-Indicator1]
  dt_use[, ChangeColor := ifelse(Change>0, "Increase", "Decrease")]
  dt_use[
    Impute_Forward1 == "Forward" & Impute_Forward2 == "Forward", # both forward imputed, or not imputed at all
    ChangeYears := {
      year2_selected - year1_selected - ImputeYears1 + ImputeYears2
    }
  ]
  dt_use[
    Impute_Forward1 == "Backward" & Impute_Forward2 == "Forward", # first backward imputed, second forward
    ChangeYears := {
      year2_selected - year1_selected + ImputeYears1 + ImputeYears2
    }
  ]
  dt_use[
    Impute_Forward1 == "Forward" & Impute_Forward2 == "Backward", # first forward imputed, second backward
    ChangeYears := {
      year2_selected - year1_selected - ImputeYears1 - ImputeYears2
    }
  ]
  dt_use[
    Impute_Forward1 == "Backward" & Impute_Forward2 == "Backward", # both backward imputed
    ChangeYears := {
      year2_selected - year1_selected + ImputeYears1 - ImputeYears2
    }
  ]
  dt_use[, AnnualizedChange := Change/ChangeYears]
  dt_use[, Change := abs(Change)]
  dt_use[, Country_name := factor(Country_name, levels = Country_name[order(Indicator1)])]
  dt_use[
    is.nan(AnnualizedChange), 
    AnnualizedChange := 0
  ]
  #dt_use <- na.omit(dt_use)
  
  # Define tooltip
  dt_use[
    , 
    text_tooltip := 
      paste0(
        "Economy: ", Country_name, "\n",
        "Region: ", Region_name, "\n", 
        "Initial Value: ", round(Indicator1, 2), "\n", 
        "Annualized Change: ", round(AnnualizedChange, 2)
      )
  ]
  
  # Return
  return(dt_use)
  
}




```






Trends {#tab_trends}
===========================================================



Sidebar {.sidebar data-width=250}
-----------------------------------------------------------------------

```{r}

# Plot by ----------------------------------------------------------------------

## Plot single region aggregate or 
selectInput("plot_which_trend", 
                   label = "Plot:",  
                   choices = c(
                     "Regional aggregates", 
                     "Selected economies", 
                     "Both"
                   ), 
                   selected = c("Regional aggregates"), 
                   multiple = FALSE
)



# Lineup or Surveys ------------------------------------------------------------

conditionalPanel(
  condition = "input.plot_which_trend == 'Selected economies'", 
  radioButtons(
    "lineup_or_survey_trend", 
    label    = "Plot interpolated or survey data:", 
    choices  = c(
      "Interpolated", 
      "Survey"
    ), 
    selected = "Interpolated"
  )
)

conditionalPanel(
  condition = "input.plot_which_trend == 'Regional aggregates' | input.plot_which_trend == 'Both' ", 
  radioButtons(
    "lineup_or_survey_trend_interpolated", 
    label    = "Plot interpolated or survey data:", 
    choices  = c(
      "Interpolated"
    ), 
    selected = "Interpolated"
  )
)



# Select Economies or Regions --------------------------------------------------

## Select regional aggregates
conditionalPanel(
  condition  = "input.plot_which_trend == 'Regional aggregates'",
  selectInput(
    "select_regional_aggregates_trend", 
    label    = "Selected regional aggregates:", 
    choices  = c(
      "All", 
      dt_region$Region_name[
        !dt_region$Region_name == "Global"
      ] |> 
        unique() |> 
        sort(), 
      "Global"
    ), 
    selected = c(
              "Sub-Saharan Africa", 
              #"Europe & Central Asia" , 
              #"Latin America & Caribbean", 
              "South Asia", 
              "East Asia & Pacific"#, 
              #"Middle East & North Africa" 
            ), 
    multiple = TRUE
  )
)

## Select economies
conditionalPanel(
  condition  = "input.plot_which_trend == 'Selected economies'",
  selectInput(
    "select_economies_trend", 
    label    = "Select economies:", 
    choices  = c(
      dt_country$Country_name |> 
        unique() |> 
        sort()
    ), 
    selected = c(
      "Ghana", 
      "Colombia", 
      "Thailand"
    ), 
    multiple = TRUE
  )
)

## Select both
conditionalPanel(
  condition  = "input.plot_which_trend == 'Both'",
  selectInput(
    "select_both_trend", 
    label    = "Select economies:", 
    choices  = c(
      dt_region$Region_name[
        !dt_region$Region_name == "Global"
      ] |> 
        unique() |> sort(),
      dt_country$Country_name |> 
        unique() |> 
        sort()
    ), 
    selected = c(
      "Sub-Saharan Africa",
      "Ghana", 
      "Colombia", 
      "Thailand"
    ), 
    multiple = TRUE
  )
)


# Indicator Fig 1 --------------------------------------------------------------

## Select indicator fig 1
conditionalPanel(
  condition = "input.plot_which_trend == 'Regional aggregates'",
  selectInput("indicator_trend1_regionalaggregates",
            label = "Select one indicator:",
            choices = c(
              "Prosperity Gap", 
              "Mean", 
              "(PG) Inequality"#, 
              #"Growth - Prosperity Gap", 
              #"Growth - Mean", 
              #"Growth - (PG) Inequality"
             ),
            selected = "Prosperity Gap")
)

## Select indicator fig 1
conditionalPanel(
  condition = "input.plot_which_trend == 'Both'",
  selectInput("indicator_trend1_both",
            label = "Select one indicator:",
            choices = c(
              "Prosperity Gap", 
              "Mean", 
              "(PG) Inequality"#,
              #"Growth - Prosperity Gap", 
              #"Growth - Mean", 
              #"Growth - (PG) Inequality"
             ),
            selected = "Prosperity Gap")
)

## Select indicator fig 1
conditionalPanel(
  condition = "input.plot_which_trend == 'Selected economies'",
  selectInput("indicator_trend1_economies",
            label = "Select one indicator:",
            choices = c(
              "Prosperity Gap", 
              "Mean", 
              "Mean - Bottom 40",
              "(PG) Inequality", 
              #"Growth - Prosperity Gap", 
              #"Growth - Mean", 
              #"Growth - Mean Bottom 40",
              #"Growth - (PG) Inequality", 
              "Poverty headcount - $2.15", 
              "Poverty headcount - $3.65", 
              "Poverty headcount - $6.85"
             ),
            selected = "Prosperity Gap")
)

# Indicator Fig 2 --------------------------------------------------------------

## Select indicator fig 2
conditionalPanel(
  condition = "input.plot_which_trend == 'Regional aggregates'",
  selectInput("indicator_trend2_regionalaggregates",
            label = "Select second comparison indicator:",
            choices = c(
              "Prosperity Gap", 
              "Mean", 
              "(PG) Inequality"#, 
              #"Growth - Prosperity Gap", 
              #"Growth - Mean", 
              #"Growth - (PG) Inequality"
             ),
            selected = "Mean")
)

## Select indicator fig 2
conditionalPanel(
  condition = "input.plot_which_trend == 'Both'",
  selectInput("indicator_trend2_both",
            label = "Select second comparison indicator:",
            choices = c(
              "Prosperity Gap", 
              "Mean", 
              "(PG) Inequality"#,
              #"Growth - Prosperity Gap", 
              #"Growth - Mean", 
              #"Growth - (PG) Inequality"
             ),
            selected = "Mean")
)

## Select indicator fig 2
conditionalPanel(
  condition = "input.plot_which_trend == 'Selected economies'",
  selectInput("indicator_trend2_economies",
            label = "Select second comparison indicator:",
            choices = c(
              "Prosperity Gap", 
              "Mean", 
              "Mean - Bottom 40",
              "(PG) Inequality", 
              #"Growth - Prosperity Gap", 
              #"Growth - Mean", 
              #"Growth - Mean Bottom 40",
              #"Growth - (PG) Inequality", 
              "Poverty headcount - $2.15", 
              "Poverty headcount - $3.65", 
              "Poverty headcount - $6.85"
             ),
            selected = "Mean")
)

# Log axes ---------------------------------------------------------------------



## Log fig 1
conditionalPanel(
  condition = "input.plot_which_trend == 'Regional aggregates' & 
  (input.indicator_trend1_regionalaggregates == 'Prosperity Gap' | 
  input.indicator_trend1_regionalaggregates == 'Mean' | 
  input.indicator_trend1_regionalaggregates == '(PG) Inequality' |
  input.indicator_trend1_regionalaggregates == 'Mean - Bottom 40')", 
  checkboxInput("log_y_3_fig1_regionalaggregates", 
              label = "Log y-axis in Figure 1:",  
              value = FALSE)
)
conditionalPanel(
  condition = "input.plot_which_trend == 'Selected economies' & 
  (input.indicator_trend1_economies == 'Prosperity Gap' | 
  input.indicator_trend1_economies == 'Mean' | 
  input.indicator_trend1_economies == '(PG) Inequality' |
  input.indicator_trend1_economies == 'Mean - Bottom 40')", 
  checkboxInput("log_y_3_fig1_economies", 
              label = "Log y-axis in Figure 1:",  
              value = FALSE)
)
conditionalPanel(
  condition = "input.plot_which_trend == 'Both' & 
  (input.indicator_trend1_both == 'Prosperity Gap' | 
  input.indicator_trend1_both == 'Mean' | 
  input.indicator_trend1_both == '(PG) Inequality' |
  input.indicator_trend1_both == 'Mean - Bottom 40')", 
  checkboxInput("log_y_3_fig1_both", 
              label = "Log y-axis in Figure 1:",  
              value = FALSE)
)

## Log fig 2
conditionalPanel(
  condition = "input.plot_which_trend == 'Regional aggregates' & 
  (input.indicator_trend2_regionalaggregates == 'Prosperity Gap' | 
  input.indicator_trend2_regionalaggregates == 'Mean' | 
  input.indicator_trend2_regionalaggregates == '(PG) Inequality' |
  input.indicator_trend2_regionalaggregates == 'Mean - Bottom 40')", 
  checkboxInput("log_y_3_fig2_regionalaggregates", 
              label = "Log y-axis in Figure 2:",  
              value = FALSE)
)
conditionalPanel(
  condition = "input.plot_which_trend == 'Selected economies' & 
  (input.indicator_trend2_economies == 'Prosperity Gap' | 
  input.indicator_trend2_economies == 'Mean' | 
  input.indicator_trend2_economies == '(PG) Inequality' |
  input.indicator_trend2_economies == 'Mean - Bottom 40')", 
  checkboxInput("log_y_3_fig2_economies", 
              label = "Log y-axis in Figure 2:",  
              value = FALSE)
)
conditionalPanel(
  condition = "input.plot_which_trend == 'Both' & 
  (input.indicator_trend2_both == 'Prosperity Gap' | 
  input.indicator_trend2_both == 'Mean' | 
  input.indicator_trend2_both == '(PG) Inequality' |
  input.indicator_trend2_both == 'Mean - Bottom 40')", 
  checkboxInput("log_y_3_fig2_both", 
              label = "Log y-axis in Figure 2:",  
              value = FALSE)
)



# Years ------------------------------------------------------------------------

## Select years to plot
radioButtons(
  "all_years_plot_trend", 
  label = "Select years to plot:",  
  choices = c(
    "All", 
    "Custom"
    ), 
  selected = c("All")
)

## If custom then choose initial years
conditionalPanel(
  condition = "input.all_years_plot_trend == 'Custom'",
  selectInput("select_initial_year_trend", 
              label = "Initial year:",
              choices = dt_country$Year |> 
                unique() |> 
                sort(),
              selected = dt_country$Year |> 
                min(), 
              multiple = FALSE)
)

## If custom then choose final year
conditionalPanel(
  condition = "input.all_years_plot_trend == 'Custom'",
  selectInput("select_final_year_trend", 
              label = "Final year:",
              choices = dt_country$Year |> 
                unique() |> 
                sort(),
              selected = dt_country$Year |> 
                max(), 
              multiple = FALSE)
)

observeEvent(
  input$select_initial_year_trend, 
  {
    updated_choices <- dt_country[
      Year >= as.numeric(input$select_initial_year_trend), 
      unique(Year)
    ]
    updated_choices <- sort(updated_choices)
    updateSelectInput(
      session, 
      "select_final_year_trend", 
      choices  = updated_choices, 
      selected = dt_country$Year |> 
        max()
    )
             }

)

```


```{r}
# Trend Data 1 -----------------------------------------------------------------

dt_trend_plot1 <- reactive({


  # If 'Regional aggregates' -----------------------------
  if(input$plot_which_trend == "Regional aggregates"){
    
    indicator_trend1 <- input$indicator_trend1_regionalaggregates
    if(!indicator_trend1 %chin% c("PG", "Mean_b40", "Mean", "Inequality")){
    indicator_trend1 <- switch(
      indicator_trend1,
      "Prosperity Gap"           = "PG",
      "Mean - Bottom 40"         = "Mean_b40",
      "Mean"                     = "Mean",
      "(PG) Inequality"          = "Inequality", 
      "Growth - Prosperity Gap"  = "PG_growth", 
      "Growth - Mean"            = "Mean_growth" , 
      "Growth - Mean Bottom 40"  = "Mean_b40_growth" , 
      "Growth - (PG) Inequality" = "Inequality_growth"
    )
    }
    
    dt_trend_plot1 <- copy(dt_region)
    #dt_trend_plot1 <- dt_trend_plot1[!Region_name == "Global"]
    dt_trend_plot1[
      Region_name == "Global", 
      PG := PG_decomp
    ]
    setnames(
      dt_trend_plot1, 
      old = c("Region_name", indicator_trend1), 
      new = c("Economy", "IndicatorTrend1")
    )
  
    dt_trend_plot1[
      ,
      text_tooltip := (
        paste0(
          "Economy: "                     , Economy, "\n",
          "Year: "                        , Year,
          "\n"                            , input$indicator_trend1_regionalaggregates, ": ", round(IndicatorTrend1, 2)
        )
      )
    ]
    
    # Filter regions
    if("All" %chin% input$select_regional_aggregates_trend){
      dt_trend_plot1
    } else {
      dt_trend_plot1 <- dt_trend_plot1[
        Economy %chin% input$select_regional_aggregates_trend
    ]
    }
    
    dt_trend_plot1[, Survey_comparability := 1L]

  }
  
  
  # If 'Selected economies' ------------------------------
  if(input$plot_which_trend == "Selected economies"){
    
    indicator_trend1 <- input$indicator_trend1_economies
    if(!indicator_trend1 %chin% c("PG", "Mean_b40", "Mean", "Inequality")){
    indicator_trend1 <- switch(
      indicator_trend1,
      "Prosperity Gap"            = "PG",
      "Mean - Bottom 40"          = "Mean_b40",
      "Mean"                      = "Mean",
      "(PG) Inequality"           = "Inequality", 
      "Growth - Prosperity Gap"   = "PG_growth", 
      "Growth - Mean"             = "Mean_growth" , 
      "Growth - Mean Bottom 40"   = "Mean_b40_growth" , 
      "Growth - (PG) Inequality"  = "Inequality_growth", 
      "Poverty headcount - $2.15" = "Headcount215", 
      "Poverty headcount - $3.65" = "Headcount365", 
      "Poverty headcount - $6.85" = "Headcount685"
    )
    }
    
    if( grepl(pattern = "headcount", x = input$indicator_trend1_economies) == TRUE ){
      if(input$lineup_or_survey_trend == "Survey"){
        dt_trend_plot1 <- copy(dt_headcount_survey)
      } else {
        dt_trend_plot1 <- copy(dt_headcount_lineup)
      }
    } else {
          if(input$lineup_or_survey_trend == "Survey"){
            dt_trend_plot1 <- copy(dt_country)
          } else {
            dt_trend_plot1 <- copy(dt_lineup)
          }
    }
    
    setnames(
      dt_trend_plot1, 
      old = c("Country_name", indicator_trend1), 
      new = c("Economy", "IndicatorTrend1")
    )
  
    dt_trend_plot1[
      ,
      text_tooltip := (
        paste0(
          "Economy: "                     , Economy, "\n",
          "Year: "                        , Year,
          "\n"                            , input$indicator_trend1_economies, ": ", round(IndicatorTrend1, 2)
        )
      )
    ]
    
    # Filter countries
    dt_trend_plot1 <- dt_trend_plot1[
        Economy %chin% input$select_economies_trend
    ]
    
    
  }
  
   # If 'Both' --------------------------------------------
  if(input$plot_which_trend == "Both"){
        
    indicator_trend1 <- input$indicator_trend1_both
    if(!indicator_trend1 %chin% c("PG", "Mean_b40", "Mean", "Inequality")){
    indicator_trend1 <- switch(
      indicator_trend1,
      "Prosperity Gap"           = "PG",
      "Mean - Bottom 40"         = "Mean_b40",
      "Mean"                     = "Mean",
      "(PG) Inequality"          = "Inequality", 
      "Growth - Prosperity Gap"  = "PG_growth", 
      "Growth - Mean"            = "Mean_growth" , 
      "Growth - Mean Bottom 40"  = "Mean_b40_growth" , 
      "Growth - (PG) Inequality" = "Inequality_growth"
    )
    }
    if(input$lineup_or_survey_trend_interpolated == "Survey"){
    dt_trend_c1 <- copy(dt_country)
    } else {
      dt_trend_c1 <- copy(dt_lineup)
    }

    dt_trend_c1 <- dt_trend_c1[
      , 
      .(Economy=Country_name, Year, PG, Inequality, Mean, Region_code, Survey_comparability, PG_growth, Mean_growth, Inequality_growth)
    ]
    dt_trend_r1 <- copy(dt_region)
    dt_trend_r1 <- dt_trend_r1[!Region_name == "Global"]
    dt_trend_r1 <- dt_trend_r1[
      , 
      .(Economy=Region_name, Year, PG, Inequality, Mean, Region_code, Survey_comparability = 1L, PG_growth, Mean_growth, Inequality_growth)
    ]
    
    dt_trend_plot1 <- rbindlist(
      list(
        dt_trend_c1, 
        dt_trend_r1
      )
    )
    
    setnames(
      dt_trend_plot1, 
      old = c(indicator_trend1), 
      new = c("IndicatorTrend1")
    )
  
    if(grepl(pattern = "Growth", x = input$indicator_trend1_both) == TRUE){
      roundto <- 3
    } else{
      roundto <- 2
    }
    dt_trend_plot1[
      ,
      text_tooltip := (
        paste0(
          "Economy: "                     , Economy, "\n",
          "Year: "                        , Year,
          "\n"                            , input$indicator_trend1_both, ": ", round(IndicatorTrend1, roundto)
        )
      )
    ]
    
    # Filter regions
      dt_trend_plot1 <- dt_trend_plot1[
        Economy %chin% input$select_both_trend
    ]
    
    }
  
  # Filter years
  if(input$all_years_plot_trend == "Custom"){
    
    dt_trend_plot1 <- dt_trend_plot1[
      Year >= as.numeric(input$select_initial_year_trend) & Year <= as.numeric(input$select_final_year_trend)
    ]
  }
  
  dt_trend_plot1


})



# Trend Data 2 -----------------------------------------------------------------

dt_trend_plot2 <- reactive({

    
  # If 'Regional aggregates' -----------------------------
  if(input$plot_which_trend == "Regional aggregates"){
    
    indicator_trend2 <- input$indicator_trend2_regionalaggregates
    if(!indicator_trend2 %chin% c("PG", "Mean_b40", "Mean", "Inequality")){
    indicator_trend2 <- switch(
      indicator_trend2,
      "Prosperity Gap"            = "PG",
      "Mean - Bottom 40"          = "Mean_b40",
      "Mean"                      = "Mean",
      "(PG) Inequality"           = "Inequality", 
      "Growth - Prosperity Gap"   = "PG_growth", 
      "Growth - Mean"             = "Mean_growth" , 
      "Growth - Mean Bottom 40"   = "Mean_b40_growth" , 
      "Growth - (PG) Inequality"  = "Inequality_growth"
    )
    }
    
    
    dt_trend_plot2 <- copy(dt_region)
    dt_trend_plot2 <- dt_trend_plot2[!Region_name == "Global"]
    setnames(
      dt_trend_plot2, 
      old = c("Region_name", indicator_trend2), 
      new = c("Economy", "IndicatorTrend2")
    )
        if(grepl(pattern = "Growth", x = input$indicator_trend2_regionalaggregates) == TRUE){
      roundto <- 3
    } else{
      roundto <- 2
    }
    dt_trend_plot2[
      ,
      text_tooltip := (
        paste0(
          "Economy: "                     , Economy, "\n",
          "Year: "                        , Year,
          "\n"                            , input$indicator_trend2_regionalaggregates, ": ", round(IndicatorTrend2, roundto)
        )
      )
    ]
    
    # Filter regions
    if("All" %chin% input$select_regional_aggregates_trend){
      dt_trend_plot2
    } else {
      dt_trend_plot2 <- dt_trend_plot2[
        Economy %chin% input$select_regional_aggregates_trend
    ]
    }
    
    dt_trend_plot2[, Survey_comparability := 1L]

  }
  
  
  # If 'Selected economies' ------------------------------
  if(input$plot_which_trend == "Selected economies"){
    
    indicator_trend2 <- input$indicator_trend2_economies
    if(!indicator_trend2 %chin% c("PG", "Mean_b40", "Mean", "Inequality")){
    indicator_trend2 <- switch(
      indicator_trend2,
      "Prosperity Gap"            = "PG",
      "Mean - Bottom 40"          = "Mean_b40",
      "Mean"                      = "Mean",
      "(PG) Inequality"           = "Inequality", 
      "Growth - Prosperity Gap"   = "PG_growth", 
      "Growth - Mean"             = "Mean_growth" , 
      "Growth - Mean Bottom 40"   = "Mean_b40_growth" , 
      "Growth - (PG) Inequality"  = "Inequality_growth", 
      "Poverty headcount - $2.15" = "Headcount215", 
      "Poverty headcount - $3.65" = "Headcount365", 
      "Poverty headcount - $6.85" = "Headcount685"
    )
    }
    
    if( grepl(pattern = "headcount", x = input$indicator_trend2_economies) == TRUE ){
      if(input$lineup_or_survey_trend == "Survey"){
        dt_trend_plot2 <- copy(dt_headcount_survey)
      } else {
        dt_trend_plot2 <- copy(dt_headcount_lineup)
      }
    } else {
          if(input$lineup_or_survey_trend == "Survey"){
            dt_trend_plot2 <- copy(dt_country)
          } else {
            dt_trend_plot2 <- copy(dt_lineup)
          }
    }
    
    setnames(
      dt_trend_plot2, 
      old = c("Country_name", indicator_trend2), 
      new = c("Economy", "IndicatorTrend2")
    )
      if(grepl(pattern = "Growth", x = input$indicator_trend2_economies) == TRUE){
      roundto <- 3
    } else{
      roundto <- 2
    }
    dt_trend_plot2[
      ,
      text_tooltip := (
        paste0(
          "Economy: "                     , Economy, "\n",
          "Year: "                        , Year,
          "\n"                            , input$indicator_trend2_economies, ": ", round(IndicatorTrend2, roundto)
        )
      )
    ]
    
    # Filter countries
    dt_trend_plot2 <- dt_trend_plot2[
        Economy %chin% input$select_economies_trend
    ]
    
    
  }
  
  
    
  # If 'Both' --------------------------------------------
  if(input$plot_which_trend == "Both"){
        
    indicator_trend2 <- input$indicator_trend2_both
    if(!indicator_trend2 %chin% c("PG", "Mean_b40", "Mean", "Inequality")){
    indicator_trend2 <- switch(
      indicator_trend2,
      "Prosperity Gap"           = "PG",
      "Mean - Bottom 40"         = "Mean_b40",
      "Mean"                     = "Mean",
      "(PG) Inequality"          = "Inequality", 
      "Growth - Prosperity Gap"  = "PG_growth", 
      "Growth - Mean"            = "Mean_growth" , 
      "Growth - Mean Bottom 40"  = "Mean_b40_growth" , 
      "Growth - (PG) Inequality" = "Inequality_growth"
    )
    }
    if(input$lineup_or_survey_trend_interpolated == "Survey"){
    dt_trend_c2 <- copy(dt_country)
    } else {
      dt_trend_c2 <- copy(dt_lineup)
    }
    
    dt_trend_c2 <- dt_trend_c2[
      , 
      .(Economy=Country_name, Year, PG, Inequality, Mean, Region_code, Survey_comparability, PG_growth, Mean_growth, Inequality_growth)
    ]
    dt_trend_r2 <- copy(dt_region)
    dt_trend_r2 <- dt_trend_r2[!Region_name == "Global"]
    dt_trend_r2 <- dt_trend_r2[
      , 
      .(Economy=Region_name, Year, PG, Inequality, Mean, Region_code, Survey_comparability = 1L, PG_growth, Mean_growth, Inequality_growth)
    ]
    
    dt_trend_plot2 <- rbindlist(
      list(
        dt_trend_c2, 
        dt_trend_r2
      )
    )
    
    setnames(
      dt_trend_plot2, 
      old = c(indicator_trend2), 
      new = c("IndicatorTrend2")
    )
  
    if(grepl(pattern = "Growth", x = input$indicator_trend2_both) == TRUE){
      roundto <- 3
    } else{
      roundto <- 2
    }
    dt_trend_plot2[
      ,
      text_tooltip := (
        paste0(
          "Economy: "                     , Economy, "\n",
          "Year: "                        , Year,
          "\n"                            , input$indicator_trend2_both, ": ", round(IndicatorTrend2, roundto)
        )
      )
    ]
    
    # Filter regions
      dt_trend_plot2 <- dt_trend_plot2[
        Economy %chin% input$select_both_trend
    ]
    
    }
  
    # Filter years
  if(input$all_years_plot_trend == "Custom"){
    
    dt_trend_plot2 <- dt_trend_plot2[
      Year >= as.numeric(input$select_initial_year_trend) & Year <= as.numeric(input$select_final_year_trend)
    ]
  }
  
  dt_trend_plot2


})



```




Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### One indicator

```{r}
renderPlotly({

  # give name
  if(input$plot_which_trend == "Regional aggregates"){
    ind_name <- input$indicator_trend1_regionalaggregates
  } else if(input$plot_which_trend == "Selected economies"){
    ind_name <- input$indicator_trend1_economies
  } else {
    ind_name <- input$indicator_trend1_both
  }
  

dt_trend_plot1 <- dt_trend_plot1()
# Create a subset with only the first points for each country
dt_trend_plot1[, rel_nudge_y := 0.1 * (max(IndicatorTrend1) - min(IndicatorTrend1)), by = Economy]
first_points = dt_trend_plot1[, .SD[which.min(Year)], by = Economy]
first_points = first_points[dt_trend_plot1, on = .(Economy), nomatch = 0]


# Log transformations
if(
  input$log_y_3_fig1_regionalaggregates == TRUE & 
  input$plot_which_trend == "Regional aggregates" & 
  grepl(pattern = "headcount", input$indicator_trend1_regionalaggregates) == FALSE & 
  grepl(pattern = "Growth", input$indicator_trend1_regionalaggregates) == FALSE
){
  transformation <- function(x) log(x)
} else if (
  input$log_y_3_fig1_economies == TRUE & 
  input$plot_which_trend == "Selected economies" &
  grepl(pattern = "headcount", input$indicator_trend1_economies) == FALSE & 
  grepl(pattern = "Growth", input$indicator_trend1_economies) == FALSE
){
  transformation <- function(x) log(x)
} else if (
  input$log_y_3_fig1_both == TRUE & 
  input$plot_which_trend == "Both" & 
  grepl(pattern = "headcount", input$indicator_trend1_both) == FALSE & 
  grepl(pattern = "Growth", input$indicator_trend1_both) == FALSE
) {
  transformation <- function(x) log(x)
} else {
  transformation <- function(x) x
}

# Initialize ggplot object
tp1 <- ggplot(dt_trend_plot1) +
  theme_classic() +
  theme(legend.position = "none")

# Add geom_point and geom_line
if(input$lineup_or_survey_trend == "Survey" | input$plot_which_trend == "Regional aggregates"){
  tp1 <- tp1 +
  geom_line(
    aes(
      x      = round(Year),
      y      = transformation(IndicatorTrend1),
      color  = Economy,
      group  = Survey_comparability
    ), 
    alpha    = 0.8
  )
} else {
  
  tp1 <- tp1 +
  geom_line(
    aes(
      x      = round(Year),
      y      = transformation(IndicatorTrend1),
      color  = Economy,
      group  = Survey_comparability
    ), 
    alpha    = 0.8
  )
}

tp1 <- tp1 +
  geom_point(aes(x = round(Year), y = transformation(IndicatorTrend1), color = Economy, text = text_tooltip), size = 1.5, alpha = 0.9) +
  scale_x_continuous(expand = expand_scale(mult = c(0.2, 0.2)))+
  scale_color_brewer(palette = "Dark2")

# Add geom_point and geom_line

# Add geom_text for labeling the first point for each country
#tp1 <- # Add geom_text for labeling the first point for each country
tp1 <- tp1 +
  geom_text(data = first_points,
            aes(x = Year, y = transformation(IndicatorTrend1 - rel_nudge_y), label = Economy, color = Economy),
            size = 2.5)

if(
  (
    input$log_y_3_fig1_regionalaggregates == TRUE & 
    input$plot_which_trend == "Regional aggregates" & 
    grepl(pattern = "headcount", input$indicator_trend1_regionalaggregates) == FALSE & 
    grepl(pattern = "Growth", input$indicator_trend1_regionalaggregates) == FALSE
  ) |
  (
    input$log_y_3_fig1_economies == TRUE & 
    input$plot_which_trend == "Selected economies" &
    grepl(pattern = "headcount", input$indicator_trend1_economies) == FALSE & 
    grepl(pattern = "Growth", input$indicator_trend1_economies) == FALSE
  ) |
    input$log_y_3_fig1_both == TRUE & 
    input$plot_which_trend == "Both" & 
    grepl(pattern = "headcount", input$indicator_trend1_both) == FALSE & 
    grepl(pattern = "Growth", input$indicator_trend1_both) == FALSE
){
  tp1 <- tp1 +
  scale_y_log10(labels = function(x) round(exp(x), 0))
}



if(grepl(pattern = "Growth", x = ind_name) == TRUE){
  
  tp1 <- tp1 + 
    geom_hline(
      yintercept = 0, 
      linetype   = "dashed", 
      color      = "darkgrey"
    )
  
}
tp1 <- ggplotly(tp1, tooltip = "text")



tp1 <- tp1 |>
layout(
    annotations =
              list(
                x = 0,
                y = -0.1,
                text = source_text,
                showarrow = F,
                xref='paper',
                yref='paper',
                font=list(size=6, color="grey")
                ))

tp1 <- layout(tp1,
            title = list(
              text = paste("Figure 1:", title_function2(ind_name), "over time"),
              titlefont = list(
                size = 14
              )
              ),
            titlefont = list(
              color = 'black',
              size  = 14
            ),
            xaxis = list(
              title = ""
            ),
            yaxis = list(
              title = title_function_y_2(ind_name),
              titlefont = list(size  = 12)
            )
)

tp1



})
```



### Compare two indicators



```{r}
renderPlotly({

# Figure 1 ---------------------------------------------------------------------------
  # give name
  if(input$plot_which_trend == "Regional aggregates"){
    ind_name1 <- input$indicator_trend1_regionalaggregates
  } else if(input$plot_which_trend == "Selected economies"){
    ind_name1 <- input$indicator_trend1_economies
  } else {
    ind_name1 <- input$indicator_trend1_both
  }
  

dt_trend_plot1 <- dt_trend_plot1()
# Create a subset with only the first points for each country
dt_trend_plot1[, rel_nudge_y := 0.1 * (max(IndicatorTrend1) - min(IndicatorTrend1)), by = Economy]
first_points = dt_trend_plot1[, .SD[which.min(Year)], by = Economy]
first_points = first_points[dt_trend_plot1, on = .(Economy), nomatch = 0]
#

# Log transformations
if(
  input$log_y_3_fig1_regionalaggregates == TRUE & 
  input$plot_which_trend == "Regional aggregates" & 
  grepl(pattern = "headcount", input$indicator_trend1_regionalaggregates) == FALSE & 
  grepl(pattern = "Growth", input$indicator_trend1_regionalaggregates) == FALSE
){
  transformation <- function(x) log(x)
} else if (
  input$log_y_3_fig1_economies == TRUE & 
  input$plot_which_trend == "Selected economies" &
  grepl(pattern = "headcount", input$indicator_trend1_economies) == FALSE & 
  grepl(pattern = "Growth", input$indicator_trend1_economies) == FALSE
){
  transformation <- function(x) log(x)
} else if (
  input$log_y_3_fig1_both == TRUE & 
  input$plot_which_trend == "Both" & 
  grepl(pattern = "headcount", input$indicator_trend1_both) == FALSE & 
  grepl(pattern = "Growth", input$indicator_trend1_both) == FALSE
) {
  transformation <- function(x) log(x)
} else {
  transformation <- function(x) x
}

# Initialize ggplot object
tp1 <- ggplot(dt_trend_plot1) +
  theme_classic() +
  theme(legend.position = "none")

# Add geom_point and geom_line
# Add geom_point and geom_line
if(input$lineup_or_survey_trend == "Survey" | input$plot_which_trend == "Regional aggregates"){
  tp1 <- tp1 +
  geom_line(
    aes(
      x      = round(Year),
      y      = transformation(IndicatorTrend1),
      color  = Economy,
      group  = Survey_comparability
    ), 
    alpha    = 0.8
  )
} else {
  
  tp1 <- tp1 +
  geom_line(
    aes(
      x      = round(Year),
      y      = transformation(IndicatorTrend1),
      color  = Economy,
      group  = Survey_comparability
    ), 
    alpha    = 0.8
  )
}
tp1 <- tp1 +
  geom_point(aes(x = round(Year), y = transformation(IndicatorTrend1), color = Economy, text = text_tooltip), size = 1.5, alpha = 0.9) +
  scale_x_continuous(expand = expand_scale(mult = c(0.2, 0.2)))+
  scale_color_brewer(palette = "Dark2")

# Add geom_point and geom_line

# Add geom_text for labeling the first point for each country
#tp1 <- # Add geom_text for labeling the first point for each country
tp1 <- tp1 +
  geom_text(data = first_points,
            aes(x = Year, y = transformation(IndicatorTrend1 - rel_nudge_y), label = Economy, color = Economy),
            size = 2.5)

if(
  (
    input$log_y_3_fig1_regionalaggregates == TRUE & 
    input$plot_which_trend == "Regional aggregates" & 
    grepl(pattern = "headcount", input$indicator_trend1_regionalaggregates) == FALSE & 
    grepl(pattern = "Growth", input$indicator_trend1_regionalaggregates) == FALSE
  ) |
  (
    input$log_y_3_fig1_economies == TRUE & 
    input$plot_which_trend == "Selected economies" &
    grepl(pattern = "headcount", input$indicator_trend1_economies) == FALSE & 
    grepl(pattern = "Growth", input$indicator_trend1_economies) == FALSE
  ) |
    input$log_y_3_fig1_both == TRUE & 
    input$plot_which_trend == "Both" & 
    grepl(pattern = "headcount", input$indicator_trend1_both) == FALSE & 
    grepl(pattern = "Growth", input$indicator_trend1_both) == FALSE
){
  tp1 <- tp1 +
  scale_y_log10(labels = function(x) round(exp(x), 0))
}


if(grepl(pattern = "Growth", x = ind_name1) == TRUE){
  
  tp1 <- tp1 + 
    geom_hline(
      yintercept = 0, 
      linetype   = "dashed", 
      color      = "darkgrey"
    )
  
}
tp1 <- ggplotly(tp1, tooltip = "text")




# Figure 2 --------------------------------------------------------------------

  # give name
  if(input$plot_which_trend == "Regional aggregates"){
    ind_name2 <- input$indicator_trend2_regionalaggregates
  } else if(input$plot_which_trend == "Selected economies"){
    ind_name2 <- input$indicator_trend2_economies
  } else {
    ind_name2 <- input$indicator_trend2_both
  }
  
dt_trend_plot2 <- dt_trend_plot2()
# Create a subset with only the first points for each country
dt_trend_plot2[, rel_nudge_y := 0.1 * (max(IndicatorTrend2) - min(IndicatorTrend2)), by = Economy]
first_points = dt_trend_plot2[, .SD[which.min(Year)], by = Economy]
first_points = first_points[dt_trend_plot2, on = .(Economy), nomatch = 0]
#

# Log transformations
if(
  input$log_y_3_fig2_regionalaggregates == TRUE & 
  input$plot_which_trend == "Regional aggregates" & 
  grepl(pattern = "headcount", input$indicator_trend2_regionalaggregates) == FALSE & 
  grepl(pattern = "Growth", input$indicator_trend2_regionalaggregates) == FALSE
){
  transformation <- function(x) log(x)
} else if (
  input$log_y_3_fig2_economies == TRUE & 
  input$plot_which_trend == "Selected economies" &
  grepl(pattern = "headcount", input$indicator_trend2_economies) == FALSE & 
  grepl(pattern = "Growth", input$indicator_trend2_economies) == FALSE
){
  transformation <- function(x) log(x)
} else if (
  input$log_y_3_fig2_both == TRUE & 
  input$plot_which_trend == "Both" & 
  grepl(pattern = "headcount", input$indicator_trend2_both) == FALSE & 
  grepl(pattern = "Growth", input$indicator_trend2_both) == FALSE
) {
  transformation <- function(x) log(x)
} else {
  transformation <- function(x) x
}

# Initialize ggplot object
tp2 <- ggplot(dt_trend_plot2) +
  theme_classic() +
  theme(legend.position = "none")

# Add geom_point and geom_line
if(input$lineup_or_survey_trend == "Survey" | input$plot_which_trend == "Regional aggregates"){
  tp2 <- tp2 +
  geom_line(
    aes(
      x      = round(Year),
      y      = transformation(IndicatorTrend2),
      color  = Economy,
      group  = Survey_comparability
    ), 
    alpha    = 0.8
  )
} else {
  
  tp2 <- tp2 +
  geom_line(
    aes(
      x      = round(Year),
      y      = transformation(IndicatorTrend2),
      color  = Economy,
      group  = Survey_comparability
    ), 
    alpha    = 0.8
  )
}
tp2 <- tp2 +
  geom_point(
    aes(
      x = round(Year), 
      y = transformation(IndicatorTrend2), 
      color = Economy,
      text = text_tooltip
    ), 
    size = 1.5, 
    alpha = 0.9
  ) +
  scale_x_continuous(
    expand = expand_scale(
      mult = c(0.2, 0.2)
    )
  )+
  scale_color_brewer(palette = "Dark2")

# Add geom_point and geom_line

# Add geom_text for labeling the first point for each country
tp2 <- tp2 +
  geom_text(data = first_points,
            aes(x = Year, y = transformation(IndicatorTrend2 - rel_nudge_y), label = Economy, color = Economy),
            size = 2.5)

if(
  (
    input$log_y_3_fig2_regionalaggregates == TRUE & 
    input$plot_which_trend == "Regional aggregates" & 
    grepl(pattern = "headcount", input$indicator_trend2_regionalaggregates) == FALSE & 
    grepl(pattern = "Growth", input$indicator_trend2_regionalaggregates) == FALSE
  ) |
  (
    input$log_y_3_fig2_economies == TRUE & 
    input$plot_which_trend == "Selected economies" &
    grepl(pattern = "headcount", input$indicator_trend2_economies) == FALSE & 
    grepl(pattern = "Growth", input$indicator_trend2_economies) == FALSE
  ) |
    input$log_y_3_fig2_both == TRUE & 
    input$plot_which_trend == "Both" & 
    grepl(pattern = "headcount", input$indicator_trend2_both) == FALSE & 
    grepl(pattern = "Growth", input$indicator_trend2_both) == FALSE
){
  tp2 <- tp2 +
  scale_y_log10(labels = function(x) round(exp(x), 0))
}


if(grepl(pattern = "Growth", x = ind_name2) == TRUE){
  
  tp2 <- tp2 + 
    geom_hline(
      yintercept = 0, 
      linetype   = "dashed", 
      color      = "darkgrey"
    )
  
}

tp2 <- ggplotly(tp2, tooltip = "text")

# Add Titles -------------------------------------------------------------------

tp1 <- tp1 |> layout(xaxis = list(title = ''), yaxis = list(title = paste(title_function_y_2(ind_name1)), titlefont = list(size  = 12)))
tp2 <- tp2 |> layout(xaxis = list(title = ''), yaxis = list(title = paste(title_function_y_2(ind_name2)), titlefont = list(size  = 12)))

annotate_tp12 <- list(
  list(
    x = 0.25, 
    y = 1, 
    text = paste("Figure 1:", title_function2(ind_name1), "over time"), 
    xref = "paper", 
    yref = "paper", 
    xanchor = "center", 
    yanchor = "bottom", 
    showarrow = FALSE
  ), 
  list(
    x = 0.75, 
    y = 1, 
    text = paste("Figure 2:", title_function2(ind_name2), "over time"), 
    xref = "paper", 
    yref = "paper", 
    xanchor = "center", 
    yanchor = "bottom", 
    showarrow = FALSE
  )
)

tp1_and_2 <- subplot(tp1, tp2, titleY= TRUE)
tp1_and_2 <- tp1_and_2 |>
layout(
    annotations =
              list(
                x = 0,
                y = -0.1,
                text = source_text,
                showarrow = F,
                xref='paper',
                yref='paper',
                font=list(size=6, color="grey")
                ))
tp1_and_2 <- tp1_and_2 |> 
  layout(
    annotations = annotate_tp12
  )
tp1_and_2



})
```





Decomposition
===========================================================


Sidebar {.sidebar data-width=200}
-----------------------------------------------------------------------


```{r sidebar-barchart}

selectInput(
  "level_or_growth_decomposition", 
  label     = "Level or growth decomposition:", 
  choices   = c(
    "Level", 
    "Growth"
  ), 
  selected  = "Level", 
  multiple = FALSE
)

conditionalPanel(
  condition = "input.level_or_growth_decomposition == 'Level'", 
  selectInput( "select_regions_barchart", 
               label    = "Decompose global PG into selected regional contributions:", 
               choices  = c(
                 "All",
                 dt_region$Region_name |> 
                   unique() |> 
                   sort()
               ), 
               selected = c(
                 "All"
               ), 
               multiple = TRUE
  )
)

conditionalPanel(
  condition = "input.level_or_growth_decomposition == 'Growth'", 
  selectInput( "select_regions_barchart_growth", 
               label    = "Decompose selected region's PG growth:", 
               choices  = c(
                 (dt_region$Region_name |> 
                    unique() |> 
                    sort())[
                      !(
                        dt_region$Region_name |> 
                          unique() |> 
                          sort()
                      ) == "Global"
                    ] , 
                 "Global"
               ), 
               selected = c(
                 "East Asia & Pacific"
               ), 
               multiple = FALSE
  )
)


radioButtons("all_years_barchart", 
                   label = "Years selection:",  
                   choices = c(
                     "All", 
                     "Custom range", 
                     "Custom selection"
                   ), 
                   selected = c("All"))

## Custom range
conditionalPanel(
  condition = "input.all_years_barchart == 'Custom range'",
  selectInput("select_initial_year_barchart", 
              label = "Initial year:",
              choices = dt_region$Year |> 
                unique() |> 
                sort(),
              selected = dt_region$Year |> 
                min(), 
              multiple = FALSE)
)

conditionalPanel(
  condition = "input.all_years_barchart == 'Custom range' && input.all_years_barchart != null",
  selectInput("select_final_year_barchart", 
              label = "Final year:",
              choices = dt_region$Year |> 
                unique() |> 
                sort(),
              selected = dt_region$Year |> 
                max(), 
              multiple = FALSE)
)

observeEvent(input$select_initial_year_table, 
             {
               updated_choices <- dt_region[
                 Year >= as.numeric(input$select_initial_year_table), 
                 unique(Year)
               ]
               updated_choices <- sort(updated_choices)
               updateSelectInput(
                 session, 
                 "select_final_year_barchart", 
                 choices = updated_choices, 
                 selected = dt_region$Year |> max() 
               )
})

## Custom selection
conditionalPanel(
  condition = "input.all_years_barchart == 'Custom selection'",
  selectInput("select_years_barchart", 
              label = "Select years:",
              choices = dt_region$Year |> 
                unique() |> 
                sort(),
              selected = c(
                2000, 
                2005, 
                2010, 
                2015
              ), 
              multiple = TRUE)
)

# Render download button
#downloadButton("downloadData", "Download CSV")

downloadButtonRmd(
  outputId = "DownloadButtonBarchart", 
  label = "CSV"
)


```

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Chart

```{r data-barchart}

dt_barchart <- reactive({
  
  if(input$level_or_growth_decomposition == "Level"){
    
  indicator <- c("PG_decomp")
  
  # Region or countries ----
    dt_barchart <- copy(dt_region)
    
    # Filter
    if(!"All" %chin% input$select_regions_barchart){
      
    dt_barchart <- dt_barchart[
      Region_name %chin% input$select_regions_barchart
    ]
    
    }
    
    setnames(
      dt_barchart,
      old = "Region_name",
      new = "Group"
    )  
  
  # Round to 2 decimal places ----
    col_round <- c("PG_decomp", "Inequality")
    dt_barchart[
      ,
      (col_round) := lapply(
        .SD,
        function(x) round(x, 2)
      ),
      .SDcols = col_round
    ]

  # Set indicator ----
  setnames(
    dt_barchart, 
    new = "Indicator", 
    old = indicator
  )
  
   # Filter years ----
  if(input$all_years_barchart == "Custom range"){
    
    dt_barchart <- dt_barchart[
      Year >= as.numeric(input$select_initial_year_barchart) & Year <= as.numeric(input$select_final_year_barchart)
    ]
    
  } else if(input$all_years_barchart == "Custom selection") {
    
    dt_barchart <- dt_barchart[
      Year %in% input$select_years_barchart
    ]
    
  }else{
    dt_barchart
  }

    
    # Step 1: Subset data for the first year
    first_year_data <- dt_barchart[Year == min(dt_barchart$Year)]

    # Step 2: Sort by indicator values
    first_year_data <- first_year_data[order(Indicator)]

    # Step 3: Extract ordered regions
    ordered_regions <- unique(first_year_data$Group)

    # Step 4: Convert Group into a factor with ordered levels
    dt_barchart[, Group := factor(Group, levels = ordered_regions, ordered = TRUE)]

  
    dt_barchart
  
    
    
  } else {
    
    # Copy data table
    dt_barchart <- copy(dt_region)
    
    # region filter
     dt_barchart <- dt_barchart[
      Region_name %chin% input$select_regions_barchart_growth
    ]
    
    dt_barchart[
      Region_name == "Global", 
      PG := PG_decomp
    ]
   # Filter years ----
   if(input$all_years_barchart == "Custom range"){
    
    dt_barchart <- dt_barchart[
      Year >= as.numeric(input$select_initial_year_barchart) & Year <= as.numeric(input$select_final_year_barchart)
    ]
    
   } else if(input$all_years_barchart == "Custom selection") {
    
    dt_barchart <- dt_barchart[
      Year %in% input$select_years_barchart
    ]
    
  }else{
    dt_barchart
  }
     

    
    dt_barchart <- dt_barchart |> 
      melt(
        id.vars       = c("Region_code", "Region_name", "Year"), 
        measure.vars  = c("PG_growth", "Inequality_growth", "Mean_growth"), 
        variable.name = "Group", 
        value.name    = "Indicator"
      )
    dt_barchart[
      , 
      Indicator := round(Indicator, 3)
    ]
    
    dt_barchart <- dt_barchart |> 
      ftransform(
        Group = fcase(
          Group == "PG_growth", "Prosperity Gap growth rate", 
          Group == "Inequality_growth", "Inequality contribution", 
          Group == "Mean_growth", "Mean contribution"#, 
          #default = Group
        )
      )
    
    dt_barchart[
      Group == "Mean contribution", 
      Indicator := -Indicator
    ]
    
    dt_barchart[
      , 
      Indicator := Indicator*100
    ]
    
    
  }

})


```


```{r plot-barchart}


renderHighchart({

# Data manipulation ------------------------------------------------------------
  dt        <- dt_barchart()
  dt_global <- dt[
    Group == "Global"
  ]
  dt        <- dt[
    !Group == "Global"
  ] 
  
  if(input$level_or_growth_decomposition == "Growth"){

  dt_pg <- dt[
    Group == "Prosperity Gap growth rate"
  ]
  dt <- dt[
      !Group == "Prosperity Gap growth rate"
    ]

  } else{
    dt_pg <- dt[
      Group == "none"
    ]
  }
  

# Make Theme -------------------------------------------------------------------
my_own_theme <- hc_theme(
  colors = RColorBrewer::brewer.pal(name = "Dark2", n = length(dt$Group |> unique())),
  chart = list(
    backgroundColor = "white"
  ),
  title = list(
    style = list(
      color = "black",
      fontFamily = "Lato"
    )
  ),
  # subtitle = list(
  #   style = list(
  #     color = "#666666",
  #     fontFamily = "Shadows Into Light"
  #   )
  # ),
  legend = list(
    itemStyle = list(
      fontFamily = "Lato",
      color = "#666666"
    ),
    itemHoverStyle = list(
      color = "gray"
    )
  )
)


#  Plot for PG -----------------------------------------------------------------
  
if(input$level_or_growth_decomposition == "Level"){
  
  # Create stacked bar chart
  hchart(
  dt,
  type = "column",
  hcaes(x = Year, y = Indicator, group = Group)
  ) |>
  hc_plotOptions(column = list(stacking = "normal")) |>
  hc_yAxis(title = list(text = "Prosperity Gap"), 
           gridLineWidth =0) |>
  hc_xAxis(categories = unique(dt$Year)) |>
  hc_legend(reverse = TRUE) |> 
  hc_credits(enabled = TRUE, text = paste0("Source: ", source_text)) |>
  hc_title(text = paste0("Decomposition of ", "Prosperity Gap" 
                         , " by region")) |> 
  hc_add_theme(my_own_theme) |> 
  hc_xAxis(categories = list("Europe & Asia", "Latin America & Caribbean","Middle East & North Africa", "Other High Income Countries","South Asia", "Sub-Saharan Africa", "East Asia & Pacific" )) |>
  hc_add_series(data = dt_global, type = "line", hcaes(x = Year, y = Indicator, group = Group), color = "black")

  
} else {
  
  dt_pg <- rbindlist(
    list(
      dt_pg[, .(Indicator, Year, Group)], 
      data.table(Indicator = 0L, Year = seq(from = min(dt_pg$Year), to = max(dt_pg$Year)), Group = "Zero growth line")
    )
  )
  
    # Create stacked bar chart
  hchart(
  dt,
  type = "column",
  hcaes(x = Year, y = Indicator, group = Group)
  ) |>
  hc_plotOptions(column = list(stacking = "normal")) |>
  hc_yAxis(title = list(text = "Annual growth rates (percentage)"), 
           gridLineWidth =0#,
           #plotlines = list(list(value = 1, color = "red", width = 2,
                            #   dashstyle = "shortdash"))
           ) |>
  hc_xAxis(categories = unique(dt$Year)) |>
  hc_legend(reverse = TRUE) |> 
  hc_credits(enabled = TRUE, text = paste0("Source: ", source_text)) |>
  hc_title(text = paste0("Decomposition of ", "growth in Prosperty Gap" 
                         , " for selected region")) |> 
  hc_add_theme(my_own_theme) |> 
  hc_xAxis(categories = list("Inequality growth", "Mean growth", "PG growth")) |>
  hc_add_series(data = dt_pg, type = "line", hcaes(x = Year, y = Indicator, group = Group), color = c("black", "grey"), chart.plotOptions.line.marker.enabled = FALSE) #|> 
  #hc_add_series(data = data.table(Indicator = 0L, Year = seq(from = 1990, to = 2019), Group = "Zero growth line"), 
  #              hcaes(x = Year, y = Indicator, Group = Group), 
  #              type = "line", color = "darkgrey")
    
  
  
}


})



output$DownloadButtonBarchart <- downloadHandler(
  filename = function() {
    paste("prosperity-gap-decomposition", Sys.Date(), ".csv", sep = "")
  },
  content = function(file) {
    write.csv(
      dt_barchart()
      , file)
  }
)



```

### Explanation

<span class="underline">Level decomposition:</span>

<p style="text-align: justify;">
    This chart shows the level of global Prosperity Gap decomposed annually by regional contributions. Regional contribution is the regional Prosperity Gap adjusted for by the region’s share of global population.</p>

<span class="underline">Growth decomposition:</span>

<p style="text-align: justify;">
    This chart shows the annual growth in the Prosperity Gap decomposed into the growth in the mean and the changes in inequality. Note that a negative growth in the Prosperity Gap indicates improving welfare as does a decline in inequality. Since the mean in the decomposition of the Prosperity Gap is in the denominator, the negative growth in the mean in this chart also shows an improvement.
</p>


Change over Time
===========================================================


Sidebar {.sidebar data-width=200}
-----------------------------------------------------------------------

```{r sidebar-plot-1}

# Plot by ----------------------------------------------------------------------

## Plot single region aggregate or 
selectInput("plot_which_change", 
                   label = "Plot:",  
                   choices = c(
                     "Regional aggregates", 
                     "Countries"
                   ), 
                   selected = c("Regional aggregates"), 
                   multiple = FALSE)



# Indicator --------------------------------------------------------------------

## Select Indicator
conditionalPanel(
  condition = "input.plot_which_change == 'Regional aggregates'", 
  selectInput(
    "indicator_region_change", 
    label    = "Select indicator:", 
    choices  = c(
      "Prosperity Gap", 
      "Mean", 
      "(PG) Inequality"
    ), 
    selected = "Prosperity Gap", 
    multiple = FALSE
  )
)
conditionalPanel(
  condition = "input.plot_which_change == 'Countries'", 
  selectInput(
    "indicator_country_change", 
    label    = "Select indicator:", 
    choices  = c(
      "Prosperity Gap", 
      "Mean", 
      "Mean - Bottom 40",
      "(PG) Inequality"
    ), 
    selected = "Prosperity Gap", 
    multiple = FALSE
  )
)


# Year -------------------------------------------------------------------------

## Select initial year
conditionalPanel(
  condition  = "input.plot_which_change == 'Regional aggregates'", 
  selectInput(
    "initial_year_region_change",
    label    = "Initial year:",
    choices  = dt_region$Year |> 
      unique() |>
      sort(), 
    selected = 2000, 
    multiple = FALSE
  )
)
conditionalPanel(
  condition  = "input.plot_which_change == 'Countries'", 
  selectInput(
    "initial_year_country_change", 
    label    = "Initial year:",
    choices  = dt_country$Year |> 
      unique() |>
      sort(), 
    selected = 2000, 
    multiple = FALSE
  )
)

## Select Interval
sliderInput("interval_change", 
             label = "Interval Length: measure the change over how many years?",
             min = 1, max = 10, value = 10, step = 1)

# Select window
conditionalPanel(
  condition = "input.plot_which_change == 'Countries'", 
  sliderInput(
    "window_change", 
    label = "Circa years window:", 
    min   = 0, 
    max   = 5, 
    value = 0, 
    step  = 1
  )
)


conditionalPanel(
  condition = "input.plot_which_change == 'Countries'", 
  selectInput(
  "do_not_plot", 
  label    = "Remove from plot:", 
  choices  = c(
    countries_lookup$Region_name |> 
      sort() |> 
      unique(), 
    countries_lookup$Country_name |> 
      sort() |> 
      unique()
  ), 
  selected = NULL,
  multiple = TRUE
)
)

downloadButtonRmd(
  outputId = "DownloadButtonChange", 
  label = "csv"
)

```


Column {.tabset .tabset}
-----------------------------------------------------------------------

### Chart 


```{r data-filter-1}
dt_use <- reactive({
  
  if(input$plot_which_change == "Regional aggregates"){
    
    # indicator ---------------------------------
    indicator_change <- input$indicator_region_change
    if(!indicator_change %chin% c("PG", "Mean_b40", "Mean", "Inequality")){
    indicator_change <- switch(
      indicator_change,
      "Prosperity Gap"   = "PG",
      "Mean"             = "Mean",
      "(PG) Inequality"       = "Inequality"
    )
    }
  
    # Data --------------------------------------
    dt_use <- copy(dt_region)
    dt_use <- dt_use[
      ! Region_name == "Global"
    ]
    setnames(
      dt_use, 
      old = c(indicator_change), 
      new = c("Indicator")
    )
    # Filter years ------------------------------
    dt_1 <- dt_use[
    Year == as.numeric(input$initial_year_region_change)
    ]
    setnames(
      dt_1, 
      old = c("Indicator"), 
      new = c("Indicator1")
    )
    dt_2 <- dt_use[
      Year == (as.numeric(input$initial_year_region_change) + as.numeric(input$interval_change))
    ]
    setnames(
      dt_2, 
      old = c("Indicator"), 
      new = c("Indicator2")
    )
    
    # Join --------------------------------------
    dt_use <- joyn::merge(
      x     = dt_1, 
      y     = dt_2, 
      yvars = T, 
      by    = "Region_name"
    )
    
    # Create vars -------------------------------
    dt_use[
      , 
      `:=`(
        Change = Indicator2 - Indicator1, 
        ChangeYears = input$interval_change
      )
    ]
    # Round
    dt_use[
      , 
      `:=`(
        Indicator1 = round(Indicator1, 2)
      )
    ]
    dt_use[
      , 
      `:=`(
        AnnualizedChange = round(Change/ChangeYears, 2)
      )
    ]
    dt_use[
      ,
      report := NULL
    ]


    dt_use[, ChangeColor := ifelse(Change>0, "Increase", "Decrease")]
    dt_use[
      , 
      text_tooltip := paste0(
        "Economy: ", Region_name, "\n", 
        "Initial Value: ", Indicator1, "\n", 
        "Annualized Change: ", AnnualizedChange
      )
    ]
    dt_use[, Region_name := factor(Region_name, levels = Region_name[order(Indicator1)])]

    
  } else if( input$plot_which_change == "Countries"){
    # indicator ---------------------------------
    if(input$indicator_country_change == "(PG) Inequality"){
      indicator <- "Inequality"
    } else{
      indicator <- input$indicator_country_change
    }
    
    
  # Filter countries ----
  # create the list of countries to deselect
  deselected_countries <- c(
    countries_lookup[
      (Country_name %chin% input$do_not_plot)
    ]$Country_name,
    countries_lookup[
      (Region_name %chin% input$do_not_plot)
    ]$Country_name
  ) |>
    unique()
  # filter the countries
  dt_use <- dt_imputed[
    !(Country_name %chin% deselected_countries)
  ]
  # dt_use
  # Filter years ----
  dt_use <- dt_use[
    Year == as.numeric(input$initial_year_country_change) | Year == (as.numeric(input$initial_year_country_change) + as.numeric(input$interval_change))
  ]
  # Filter window ----
  dt_use <- dt_use[
    ImputeDistance <= as.numeric(input$window_change)
  ]


  # Create necessary columns ----
  dt_use <- create_data_imputed_by_countries_two_years_pg(
    dt = dt_use,
    countries_selected  = countries_lookup$Country_name |> unique(),
    year1_selected      = as.numeric(input$initial_year_country_change),
    year2_selected      = c(as.numeric(input$initial_year_country_change) + as.numeric(input$interval_change)),
    indicator           = indicator,
    window_length       = input$window_change
)

  dt_use
    
    
    
  }

})

```



```{r}
renderPlotly({

  if(input$plot_which_change == "Countries"){
    
    # indicator ---------------------------------
    indicator_change <- input$indicator_country_change
    if(!indicator_change %chin% c("PG", "Mean_b40", "Mean", "Inequality")){
    indicator_change <- switch(
      indicator_change,
      "Prosperity Gap"   = "PG",
      "Mean"             = "Mean",
      "Mean - Bottom 40" = "Mean_b40",
      "(PG) Inequality"       = "Inequality"
    )
    }
    
  } else{
    
    # indicator ---------------------------------
    indicator_change <- input$indicator_region_change
    if(!indicator_change %chin% c("PG", "Mean_b40", "Mean", "Inequality")){
    indicator_change <- switch(
      indicator_change,
      "Prosperity Gap"   = "PG",
      "Mean"             = "Mean",
      "(PG) Inequality"       = "Inequality"
    )
    }
    
  }

    
dt1 <- dt_use()
# Initialize ggplot object
p <- ggplot(data = dt1) +
  theme_classic() +
  theme(legend.position = "none")

# Add segment layer with arrow
if(input$plot_which_change == "Countries"){
  
  p <- p +
  geom_segment(
    aes(
      x     = Indicator1,
      xend  = Indicator2,
      y     = Country_name,
      yend  = Country_name,
      color = ChangeColor
    ),
    arrow = arrow(length = unit(0.5, "inches"), type = "closed"),
    alpha = 0.9
  )
  
} else{
  
  p <- p +
  geom_segment(
    aes(
      x     = Indicator1,
      xend  = Indicator2,
      y     = Region_name,
      yend  = Region_name,
      color = ChangeColor
    ),
    arrow = arrow(length = unit(0.5, "inches"), type = "closed"),
    alpha = 0.9
  )
  
  
}

# Add segment layer with arrow
if(input$plot_which_change == "Countries"){
  
# Add point layer first to avoid overlap
p <- p +
  geom_point(aes(x = Indicator1, y = Country_name, colour = ChangeColor, text = text_tooltip), size = 2,
    alpha = 0.9)
  
} else{
  
# Add point layer first to avoid overlap
p <- p +
  geom_point(aes(x = Indicator1, y = Region_name, colour = ChangeColor, text = text_tooltip), size = 2,
    alpha = 0.9)
  
}



# Conditional logic for color scales
if(indicator_change %chin% c("Mean", "Mean_b40")){
  p <- p +
    scale_color_manual(values = c("Increase" = "#1b9e77", "Decrease" = "#d95f02"))
} else {
  p <- p +
    scale_color_manual(values = c("Increase" = "#d95f02", "Decrease" = "#1b9e77"))
}





# Convert to plotly object
pp <- ggplotly(p, tooltip = "text")

pp <- pp |>
   layout(
       annotations =
                 list(
                   x = 0,
                   y = -0.1,
                   text = source_text,
                   showarrow = F,
                   xref='paper',
                   yref='paper',
                   font=list(size=6, color="grey")
                   ))


year1 <- ifelse(
  input$plot_which_change == "Countries", as.numeric(input$initial_year_country_change), as.numeric(input$initial_year_region_change)
)
year2 <- year1 + as.numeric(input$interval_change)

pp <- layout(pp,
            title = list(
              text = paste(
                "Change in",
                title_function(indicator_change),
                "from circa",
                year1,
                "to circa",
                year2
              )
            ),
            titlefont = list(
              color = 'black',
              size  = 14
            ),
            xaxis = list(
              title = title_function_y(indicator_change),
              titlefont = list(size = 12)
            ),
            yaxis = list(
              title = ""
            )
)

# Display the plot
pp

})



output$DownloadButtonChange <- downloadHandler(
  filename = function() {
    paste("prosperity-gap-change", Sys.Date(), ".csv", sep = "")
  },
  content = function(file) {
    write.csv(
      dt_use()
      , file)
  }
)


```


Column {.tabset data-width=200}
-----------------------------------------------------------------------
### Explanation




<p style="text-align: justify;">
    This plot shows the change in the selected indicator over time for economies where there is comparable survey data in the chosen period. The <strong style="color:black">dot</strong> gives the initial indicator value for that economy. The <strong style="color:black">horizontal line segment</strong> connects the initial and final year indicator values. The <strong style="color:black">color</strong> indicates whether an economy's outcomes improve over the chosen interval. When the overall welfare mean or the mean of the bottom 40 are selected, green indicates that these measures have increased over time. For the remaining indicators, the prosperity gap and the inequality measure, an increase is shown in red. The economies on the y-axis are ordered according to the chosen indicator, where the top country has the largest indicator value in the initial year. </p>

<strong style="color:black; text-align: justify;">What if an economy has no surveys in the chosen years?</strong>

<p style="text-align: justify;">
    Users specify the initial year (e.g., 2000) and the period over which they would like to study the change (e.g., the interval length is 5 years for looking at the 2000-2005 period). 
</p>

<p style="text-align: justify;">
    Data might be missing for some economies for specific years. To increase the number of economies available, users can specify a circa year window. For example, if the chosen circa window is 2, then data 2 years either side of 2000 are considered (i.e., between 1998 and 2002). Within the circa window, data points in the initial and final years are selected with a preference for closer and newer data points: For example, if data for 2000 is missing, the algorithm will first look for data in 2001 and if 2001 data is also missing, it will then search in 1999. If both are missing, it will look for data in 2002 and 1998. An equivalent process is applied to the final year. 
</p>

<p style="text-align: justify;">
    With a circa window larger than zero, the duration over which changes are measured differs across economies. For example, with an interval of 5 years and a window of 2, the duration varies between 1 year and 9 years (e.g. 2002-2003 and 1998-2007 are both permissible).
</p>





Scatterplot of Indicators
===========================================================



Sidebar {.sidebar data-width=200}
-----------------------------------------------------------------------

```{r sidebar-plot-2}
# Select Indicator
selectInput("ineq_indicatorX", 
            label = "Indicator x-axis:",
            choices = c(
              "Prosperity Gap",
              "Mean", 
              "Mean - Bottom 40", 
              "(PG) Inequality"
            ),
            selected = "Mean")

selectInput("ineq_indicatorY", 
            label = "Indicator y-axis:",
            choices = c(
              "Prosperity Gap",
              "Mean", 
              "Mean - Bottom 40", 
              "(PG) Inequality"
            ),
            selected = "Prosperity Gap")
 

selectInput("select_welfare_type", 
              label = "Survey type:", 
              choices = c("Both", "Consumption", "Income"), 
              selected = "Both"
)

checkboxGroupInput(
  inputId  = "log_transformations", 
  label    = "Log transformations:", 
  choices  = c("Y axis", "X axis"), 
  selected = c("X axis")
)



selectInput("countries_selected",
            label    = "Select economies:",
            choices  = c(
              "All", 
              countries_lookup$Region_name |> unique(), 
              countries_lookup$Country_name |> unique()
            ),
            selected = c("All"),
            multiple = TRUE)
# Select region for scatter plot to highlight
selectInput("background_regions",
            label    = "Select comparison economies:",
            choices  = c(
              "All", 
              countries_lookup$Region_name |> 
                unique()
            ),
            selected = "",
            multiple = TRUE)
radioButtons("color_by", 
                   label = "Color points by:",  
                   choices = c(
                     "Region", 
                     "Income group", 
                     "Same Color"
                   ), 
                   selected = c("Region"))

radioButtons("all_years_scatterplot", 
                   label = "Select years to plot:",  
                   choices = c(
                     "All", 
                     "Custom"
                   ), 
                   selected = c("All"))

conditionalPanel(
  condition = "input.all_years_scatterplot == 'Custom'",
  selectInput("select_initial_year_scatterplot", 
              label = "Initial year:",
              choices = dt_country$Year |> 
                unique() |> 
                sort(),
              selected = dt_country$Year |> 
                min(), 
              multiple = FALSE)
)

conditionalPanel(
  condition = "input.all_years_scatterplot == 'Custom'",
  selectInput("select_final_year_scatterplot", 
              label = "Final year:",
              choices = dt_country$Year |> 
                unique() |> 
                sort(),
              selected = dt_country$Year |> 
                max(), 
              multiple = FALSE)
)

observeEvent(input$select_initial_year_scatterplot, 
             {
               updated_choices <- dt_country[
                 Year >= as.numeric(input$select_initial_year_scatterplot), 
                 unique(Year)
               ]
               updated_choices <- sort(updated_choices)
               updateSelectInput(
                 session, 
                 "select_final_year_scatterplot", 
                 choices = updated_choices, 
                 selected = dt_country$Year |> max() 
               )
})

```
Advanced Features:
```{r}
checkboxInput("add_line", 
              label = "Add fitted line:", 
              value = FALSE)


downloadButtonRmd(
  outputId = "DownloadButtonScatterplot",
  label = "CSV"
)

```


Column {.tabset .tabset-fade}
-----------------------------------------------------------------------

```{r data-filter2}



selected_countries <- reactive({

  # get list of selected countries
  if(c("All") %chin% input$countries_selected){

    selected_countries <- dt_country$Country_name |> unique()

  } else {

    selected_countries <- c(
    (countries_lookup[Country_name %chin% input$countries_selected])$Country_name,
    (countries_lookup[Region_name %chin% input$countries_selected])$Country_name
  ) |> unique()

  }


    # welfare
  if(!input$select_welfare_type == c("Both")){
    selected_countries <- intersect(
      selected_countries,
      dt_country[Welfare_type == tolower(input$select_welfare_type)]$Country_name
    ) |> unique()
  } else {
    selected_countries
  }
  selected_countries

})


dt_use_sp <- reactive({
  
  # Copy pip stats
  dt_use_sp <- copy(dt_country)
  
  # filter years
  if(input$all_years_scatterplot == "Custom"){

    dt_use_sp <- dt_use_sp[
     Year >= input$select_initial_year_scatterplot &
        Year <= input$select_final_year_scatterplot
    ]

  }
  
  # Filter by survey type
  if(!input$select_welfare_type =="Both"){
    dt_use_sp <- dt_use_sp[
      Welfare_type == tolower(input$select_welfare_type)
    ]
  } else{
    dt_use_sp
  }
  
  
  # Keep selected and background countries
  if(
    ! any(
      c(
        "All" %chin% input$countries_selected,
        "All" %chin% input$background_regions
      )
    )
  ){

    # which countries to keep in data
    countries_filtered <- c(
      selected_countries(),
      countries_lookup[
        Region_name %chin% input$background_regions
      ]$Country_name
    )

    # filter
    dt_use_sp <- dt_use_sp[
      Country_name %chin% countries_filtered
    ]



  }

  if(input$ineq_indicatorX == input$ineq_indicatorY) stop("Indicators chosen for x and y axes should be different")
  
  # Change names of selected indicators
    # Change the indicator values
  ineq_indic_X <- input$ineq_indicatorX
  if(!ineq_indic_X %chin% c("PG", "Mean_b40", "Mean", "Inequality")){

    ineq_indic_X <- switch(
      ineq_indic_X,
      "Prosperity Gap"   = "PG",
      "Mean - Bottom 40" = "Mean_b40",
      "Mean"             = "Mean",
      "(PG) Inequality"       = "Inequality"
    )
  }
  ineq_indic_Y <- input$ineq_indicatorY
  if(!ineq_indic_Y %chin% c("PG", "Mean_b40", "Mean", "Inequality")){

    ineq_indic_Y <- switch(
      ineq_indic_Y,
      "Prosperity Gap"   = "PG",
      "Mean - Bottom 40" = "Mean_b40",
      "Mean"             = "Mean",
      "(PG) Inequality"       = "Inequality"
    )
  }

  setnames(
    x = dt_use_sp,
    old = c(ineq_indic_X, ineq_indic_Y),
    new = c("IndicatorX", "IndicatorY")
  )

  dt_use_sp[
    ,
    `Income Group` := incgroup_current
  ]
  #factor(incgroup_current, levels = incgroup_current[order(mean)])]
  # Define tooltip
  dt_use_sp[
    ,
    text_tooltip := (
      paste0(
        "Economy: ", Country_name, "\n",
        "Region: ", Region_name,  "\n",
        "Income Group: ", incgroup_current, "\n",
        input$ineq_indicatorX, ": ", round(IndicatorX,2),  "\n",
        input$ineq_indicatorY, ": ", round(IndicatorY, 2),  "\n",
        "Survey type: ", str_to_title(Welfare_type), "\n", 
        "Year: ", Year
      )
    )
  ]
col_vec <- c()
all_cntr <- dt_use_sp$Country_name
reg <- dt_use_sp$Region_name
inc <- dt_use_sp$incgroup_current
dt <- data.table(all_cntr = all_cntr, reg = reg)
# Conditionally define 'bla' based on the value of 'Check'
if (input$color_by == "Region") {
  dt[, col_vec := ifelse(all_cntr %chin% selected_countries(), reg, "Unselected")]
} else if (input$color_by == "Income group") {
  dt[, col_vec := ifelse(all_cntr %chin% selected_countries(), inc, "Unselected")]
} else if (input$color_by == "Same Color"){
  dt[, col_vec := rep("Same", length(reg))]
}
# Extract the 'bla' column to a vector
col_vec <- dt$col_vec

    
dt_use_sp[
  , 
  Color := col_vec
]

# Re-order for alpha values when plotting
dt_use_sp[, temp_order := Color == "Unselected"]
# Sort by the temporary column
setorder(dt_use_sp, temp_order)  # Negative sign to make TRUE come first
dt_use_sp[
  , 
  alpha_val := ifelse(
    Color == "Unselected", 0.2, 0.7
  )
]
# Remove the temporary column if it's no longer needed
dt_use_sp[, temp_order := NULL]
dt_use_sp

    })


```

### Chart

```{r plot2}

renderPlotly({


transformation_x <- function(x){

  if("X axis" %chin% input$log_transformations){
    log(x)
  } else{
    x
  }

}

transformation_y <- function(x){

  if("Y axis" %chin% input$log_transformations){
    log(x)
  } else{
    x
  }
}
# define tooltip ----
dt <- dt_use_sp()
# Initialize ggplot object
sp1 <- ggplot(
  dt
)

# Custom function to modify the palette
modify_palette <- function(palette_name, name_to_change, new_color) {
  palette <- brewer.pal(name = palette_name, n = length(unique(dt$Color)))
  names(palette) <- unique(dt$Color)
  palette[name_to_change] <- new_color
  return(palette)
}
# Modify the Dark2 palette to have "NOT" as light grey
modified_palette <- modify_palette("Dark2", "Unselected", "lightgrey")

sp1 <- sp1 +
  scale_color_manual(values = modified_palette, drop = TRUE)

# scale_color_brewer(palette = "Dark2")

# # Add geom_point
# Dynamically generate alpha values
unique_colors <- unique(dt$Color)
alpha_values <- setNames(rep(0.9, length(unique_colors)), unique_colors)
alpha_values["Unselected"] <- 0.1

if (!input$color_by == "Same Color"){
sp1 <- sp1 +
  geom_point(aes(
    x = transformation_x(IndicatorX),
    y = transformation_y(IndicatorY),
    color = Color,
    text = text_tooltip,
    alpha = alpha_val
  )
  )
} else {
  sp1 <- sp1 +
   geom_point(aes(
     x = transformation_x(IndicatorX),
     y = transformation_y(IndicatorY),
     #color = Color,
     text = text_tooltip,
     alpha = alpha_val
   ), 
   color = RColorBrewer::brewer.pal(n=3, name = "Dark2")[[1]]
   )
}


  # scale_alpha_discrete(range = c(rep(0.8, length(dt$Color |> unique()) -1, 0.1)))+
  # if("Unselected" %chin% dt$Color){
  #   sp1 <- sp1 + 
  #     scale_alpha_manual(values = c(rep(0.7, length(dt$Color |> unique()) -1, 0.2)))
  # } else {
  #   sp1 <- sp1 +
  #     scale_alpha_manual(values = c(rep(0.7, length(dt$Color |> unique()))))
  # }
  sp1 <- sp1 +
  guides(alpha=FALSE, color=guide_legend(override.aes=list(alpha=1)))



# Add geom_smooth if required
if (input$add_line == TRUE) {
  sp1 <- sp1 +
    geom_smooth(
      aes(
        x = transformation_x(IndicatorX),
        y = transformation_y(IndicatorY),
        stat = "smooth",
        position = "identity"
      )
    )
}

# Adjust theme
sp1 <- sp1 + 
  theme_classic() + 
  theme(aspect.ratio=1)
#
# if log transform, use original units
  if(c("X axis" %chin% input$log_transformations)){

      if(input$ineq_indicatorX == "Mean"){
        sp1 <- sp1 +
          scale_x_log10(
            labels = function(x) round(exp(x), 0),
            limits = c(log(1.1), log(94))
          )
      } else{
        sp1 <- sp1 +
          scale_x_log10(
            labels = function(x) round(exp(x), 0)
          )
      }

  }
  if(c("Y axis" %chin% input$log_transformations)){


        sp1 <- sp1 +
          scale_y_log10(
            labels = function(x) round(exp(x), 0)
          )


  }




# Convert to plotly object
sp1_plotly <- ggplotly(sp1, tooltip = "text")



# Display the plot
sp1_plotly <- sp1_plotly |>
   layout(
     # images = list(
     #   list(
     #     source = base64enc::dataURI(file = "Logo/logo_horizontal.png"),
     #         xref = "paper",
     #        yref = "paper",
     #        x= 0.8,
     #        y= -0.05,
     #        sizex = 0.15,
     #        sizey = 0.15,
     #        opacity = 0.8
     #   )),
       annotations =
                 list(
                   x = 0,
                   y = -0.08,
                   text = source_text,
                   showarrow = F,
                   xref='paper',
                   yref='paper',
                   font=list(size=6, color="grey")
                 ))

if((!c("X axis" %chin% input$log_transformations)) & (!c("Y axis" %chin% input$log_transformations))){
  
  sp1_plotly <- layout(sp1_plotly,
            title = list(text = paste("Relationship between", title_function2(input$ineq_indicatorX), "and", title_function2(input$ineq_indicatorY))),
            titlefont = list(size = 14),
            xaxis = list(title = title_function2(input$ineq_indicatorX), titlefont = list(size = 12)),
            yaxis = list(
              title = title_function_y_2(input$ineq_indicatorY),
              titlefont = list(size = 12)
            )
)
  
} else if((c("X axis" %chin% input$log_transformations)) & (!c("Y axis" %chin% input$log_transformations))){
  
    sp1_plotly <- layout(sp1_plotly,
            title = list(text = paste("Relationship between", title_function2(input$ineq_indicatorX), "and", title_function2(input$ineq_indicatorY))),
            titlefont = list(size = 14),
            xaxis = list(title = paste(title_function2(input$ineq_indicatorX), "\n (logarithmic scale)"), titlefont = list(size = 12)),
            yaxis = list(
              title = title_function_y_2(input$ineq_indicatorY),
              titlefont = list(size = 12)
            )
)
  
} else if((!c("X axis" %chin% input$log_transformations)) & c("Y axis" %chin% input$log_transformations)){
  
    sp1_plotly <- layout(sp1_plotly,
            title = list(text = paste("Relationship between", title_function2(input$ineq_indicatorX), "and", title_function2(input$ineq_indicatorY))),
            titlefont = list(size = 14),
            xaxis = list(title = title_function2(input$ineq_indicatorX), titlefont = list(size = 12)),
            yaxis = list(
              title = paste(title_function_y_2(input$ineq_indicatorY), "\n (logarithmic scale)"),
              titlefont = list(size = 12)
            )
)
  
}else if((c("X axis" %chin% input$log_transformations)) & c("Y axis" %chin% input$log_transformations)){
  
    sp1_plotly <- layout(sp1_plotly,
            title = list(text = paste("Relationship between", title_function2(input$ineq_indicatorX), "and", title_function2(input$ineq_indicatorY))),
            titlefont = list(size = 14),
            xaxis = list(title = paste(title_function2(input$ineq_indicatorX), "\n (logarithmic scale)"), titlefont = list(size = 12)),
            yaxis = list(
              title = paste(title_function_y_2(input$ineq_indicatorY), "\n (logarithmic scale)"),
              titlefont = list(size = 12)
            )
)
  
}





sp1_plotly


})



output$DownloadButtonScatterplot <- downloadHandler(
  filename = function() {
    paste("prosperity-gap-scatterplot", Sys.Date(), ".csv", sep = "")
  },
  content = function(file) {
    write.csv(
      dt_country
      , file)
  }
)



```



<!-- Column {.tabset data-width=200} -->
<!-- ----------------------------------------------------------------------- -->

### Explanation



<p style='text-align:justify;'>This scatterplot shows the relationship between two selected indicators. By default, it shows all data, regardless of economy, region, or whether welfare is measured by consumption or income. Making selections on the side panel will limit the display to the selected data (e.g. selecting Sub-Saharan Africa as the “Select economies” and consumption as the “Survey type” plots data for countries in Sub-Saharan Africa where welfare in survey is measured by consumption). The selected data can be compared against other economies or regions. Dots are colored by region by default, and users have the choice to color by income group or use a uniform color for all data points.</p>

<p style='text-align:justify;'>The plot provides a feature for incorporating a line to depict the underlying relationship between variables. This line represents the conditional mean, estimated via locally estimated scatterplot smoothing (LOESS), and is accompanied by 95\% confidence intervals. </p>



Table of Indicators
===========================================================


Sidebar {.sidebar data-width=200}
-----------------------------------------------------------------------

```{r sidebar-table-1}


# Region or country
selectInput(
  "table_region_or_country", 
  label    = "Show regional aggregates or countries:", 
  choices  = c(
    "Regional aggregates", 
    "Countries"
  ), 
  selected = c(
    "Regional aggregates"
  ), 
  multiple = FALSE
)

# Select Indicator
conditionalPanel(
  condition = "input.table_region_or_country == 'Regional aggregates'", 
  selectInput("ineq_indicator_table_region", 
            label = "Indicators:",
            choices = c(
              "Prosperity Gap",
              "Mean", 
              "(PG) Inequality"
            ),
            selected =  c(
              "Prosperity Gap"
            ), 
            multiple = TRUE)
)
conditionalPanel(
  condition = "input.table_region_or_country == 'Countries'", 
  selectInput("ineq_indicator_table_country", 
            label = "Indicators:",
            choices = c(
              "Prosperity Gap",
              "Mean", 
              "Mean - Bottom 40", 
              "(PG) Inequality"
            ),
            selected =  c(
              "Prosperity Gap"
            ), 
            multiple = TRUE
            )
)


conditionalPanel(
  condition = "input.table_region_or_country == 'Countries'", 
  selectInput("select_countries_table", 
            label = "Economies:",
            choices = c(
              "All", 
              dt_country$Region_name |> 
                unique() |> 
                sort(),  
              dt_country$Country_name |> 
                unique()|> 
                sort()
            ),
            selected = c("All"), 
            multiple = TRUE)
)




radioButtons("all_years_table", 
                   label = "Years shown in table:",  
                   choices = c(
                     "Latest", 
                     "All", 
                     "Custom"
                   ), 
                   selected = c("Latest"))


conditionalPanel(
  condition = "input.all_years_table == 'Custom'",
  selectInput("select_initial_year_table", 
              label = "Initial year:",
              choices = dt_country$Year |> 
                unique() |> 
                sort(),
              selected = dt_country$Year |> 
                min(), 
              multiple = FALSE)
)

conditionalPanel(
  condition = "input.all_years_table == 'Custom' && input.select_initial_year_table != null",
  selectInput("select_final_year_table", 
              label = "Final year:",
              choices = dt_country$Year |> 
                unique() |> 
                sort(),
              selected = dt_country$Year |> 
                max(), 
              multiple = FALSE)
)

observeEvent(input$select_initial_year_table, 
             {
               updated_choices <- dt_country[
                 Year >= as.numeric(input$select_initial_year_table), 
                 unique(Year)
               ]
               updated_choices <- sort(updated_choices)
               updateSelectInput(
                 session, 
                 "select_final_year_table", 
                 choices = updated_choices, 
                 selected = dt_country$Year |> max() 
               )
})


# Render download button
#downloadButton("downloadData", "Download CSV")

downloadButtonRmd(
  outputId = "DownloadButtonTable", 
  label = "CSV"
)





```


Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

###

```{r plot-table}


make_table_across_countries <- function(
    #dt_1,
    country_name_vec,
    ineq_indicators,
    years_selected = c("All", "Latest", "Custom"),
    start_year = NULL,
    end_year = NULL
){
  
  if(input$table_region_or_country == "Countries") {
    
  
  
  dt <- copy(dt_country)
  # Check Inputs ----
  stopifnot(is.data.table(dt))
  stopifnot(country_name_vec %chin% countries_lookup$Country_name)
  years_selected <- match.arg(years_selected)

  indicators_names <- ineq_indicators
    # Convert this character vector into a data.table
dt_indicators <- data.table(ineq_indicators = ineq_indicators)
ineq_indicators <- "Prosperity Gap"
#  change each name
dt_indicators[, ineq_indicators := switch(
  ineq_indicators,
  "Prosperity Gap"        = "PG",
  "Mean - Bottom 40"      = "Mean_b40",
  "Mean"                  = "Mean",
  "(PG) Inequality"       = "Inequality"
), by = ineq_indicators]
ineq_indicators <- dt_indicators$ineq_indicators
# dt_indicators$ineq_indicators
# ineq_indicators
  # Prepare Data ----
  selected_cols <- c(
    "Country",
    "Region",
    "Year",
    "Level",
    "Type",
    "Spell",
    ineq_indicators
  )


  setnames(
    dt,
    old = c("Country_name", "Region_code", "Survey_comparability", "Reporting_level", "Welfare_type"),
    new = c("Country", "Region", "Spell", "Level", "Type")                           # Clean variable names
  )

  dt <- dt[
    Country %chin% country_name_vec,         # filter by country
    ..selected_cols                             # Select id vars and inequality indicators
  ]

  dt[
    ,
    (names(dt)) := lapply(                       # Round to 2 decimals
      .SD,
      \(x){
        if (is.numeric(x))
          round(x, 2)
        else
          x
        }
    )
  ]


  # Filter years
  if(years_selected == "Latest"){
    dt <- dt[,
             .SD[which.max(Year)],
             by = Country]
  }
  if(years_selected == "Custom"){

    if(start_year > end_year)
      stop("Please note the initial year must be lower than the final year")
    dt <- dt[
      Year >= start_year &
        Year <= end_year
    ]

  }


  setorder(dt, Country, Region, -Year, Level, Type)

  dt # return

} else if(input$table_region_or_country == "Regional aggregates"){
  
  # Copy
  dt <- copy(dt_region)

  # Check Inputs ----
  stopifnot(is.data.table(dt))
  stopifnot(country_name_vec %chin% c(countries_lookup$Region_name |> unique(), "Global"))
  years_selected <- match.arg(years_selected)

  indicators_names <- ineq_indicators
  
  # Convert this character vector into a data.table
  dt_indicators <- data.table(ineq_indicators = ineq_indicators)
  ineq_indicators <- "Prosperity Gap"
  #  change each name
  dt_indicators[, ineq_indicators := switch(
    ineq_indicators,
    "Prosperity Gap"        = "PG",
    "Mean - Bottom 40"      = "Mean_b40",
    "Mean"                  = "Mean",
    "(PG) Inequality"       = "Inequality"
  ), by = ineq_indicators]
  ineq_indicators <- dt_indicators$ineq_indicators
  
  # ineq_indicators
    # Prepare Data ----
    selected_cols <- c(
      "Region",
      "Year",
      ineq_indicators
    )


   setnames(
     dt,
     old = c("Region_name"),
     new = c("Region")                           # Clean variable names
   )


   dt <- dt[
     Region %chin% country_name_vec,         # filter by country
     ..selected_cols                             # Select id vars and inequality indicators
   ]

   dt[
     ,
     (names(dt)) := lapply(                       # Round to 2 decimals
       .SD,
       \(x){
         if (is.numeric(x))
           round(x, 2)
         else
           x
         }
     )
   ]


  # Filter years
  if(years_selected == "Latest"){
    dt <- dt[,
             .SD[which.max(Year)],
             by = Region]
  }
  if(years_selected == "Custom"){

    if(start_year > end_year)
      stop("Please note the initial year must be lower than the final year")
    dt <- dt[
      Year >= start_year &
        Year <= end_year
    ]

  }


  setorder(dt, Region, -Year)

  dt # return


}

} 



table <-
  reactive({

    if(input$table_region_or_country == "Countries"){
      indic <- input$ineq_indicator_table_country 
    } else {
      indic <- input$ineq_indicator_table_region
    }
    # Filter countries

    if(input$table_region_or_country == "Countries"){
    ct <-
      if ("All" %chin% input$select_countries_table) {
      countries_lookup$Country_name
    } else {
      c(countries_lookup[Country_name %chin%
                                input$select_countries_table]$Country_name,
        countries_lookup[Region_name %chin%
                                input$select_countries_table]$Country_name
        ) |>
        unique()
    }
    } else{
      
    ct <- c(countries_lookup$Region_name, "Global")
          
    }
    
    table <- make_table_across_countries(
     # dt               = dt_pip,
      country_name_vec = ct,
      ineq_indicators  = indic,
      years_selected   = input$all_years_table,
      start_year       = input$select_initial_year_table,
      end_year         = input$select_final_year_table
  )
    if("(PG) Inequality" %chin% indic){
      setnames(
        table, 
        old = "Inequality", 
        new = "(PG) Inequality"
      )
    }
    if("PG" %chin% indic){
      setnames(
        table, 
        old = "PG", 
        new = "Prosperity Gap"
      )
    }
    table[, Spell := NULL]
    table
})



renderPlotly({

  nm <- names(table())
  cn <- table() |> colnames()
  cn[cn == "PG"] <- "Prosperity Gap"

list_of_columns <- lapply(
    nm,
    \(col_name) { # Make the columns list items for plotly
      return(table()[[col_name]])
    })

  # plot table
  t <- plot_ly(
    type = 'table',
    #columnwidth = c(100, 100),
    header = list(
      values = cn |>
        # column names vector
        str_replace_all(pattern = "_",
                        replacement = " "),
      align = "center",
      line = list(width = 1, color = 'black'),
      fill = list(color = c("grey", "grey")),
      font = list(family = "Arial", size = 10, color = "white")
    ),
    cells = list(
      values = list_of_columns,
      align  = c("center", "center"),
      line   = list(color = "black", width = 1),
      font   = list(family = "Arial", size = 10, color = c("black"))
    ))

t <- layout(
  t,
  title   = "Prosperity Gap, Selected Economies and Years",
  titlefont = list(color = 'black', size = 14),
  title_x = 0
)

 t <- t |>
   layout(
       annotations =
                 list(
                   x = 0,
                   y = -0.05,
                   text = source_text,
                   showarrow = F,
                   xref='paper',
                   yref='paper',
                   font=list(size=8, color="grey")
                   ))

})


output$DownloadButtonTable <- downloadHandler(
  filename = function() {
    paste("prosperity-gap-table", Sys.Date(), ".csv", sep = "")
  },
  content = function(file) {
    write.csv(table(), file)
  }
)



```



About and Definitions {#tab_about}
===========================================================

Column {.tabset}
-----------------------------------------------------------------------

### About Page {#About}

<!-- {data-width=500} -->
<p style='text-align:justify;'>This dashboard provides a set of interactive visualizations focused on the *Prosperity Gap* and associated indicators. The Prosperity Gap is the average factor by which incomes need to be multiplied to bring everyone in the society to the prosperity standard of \$25 daily income expressed in 2017 PPPs. \$25 a day is close to the poverty line of a typical high-income country. A Prosperity Gap of 5 implies that incomes in that society need to be increased on average 500\% for everyone to reach the \$25/day threshold. Put differently, the typical person would have to work for 5 days to earn the same amount as a person at the poverty line in rich countries would earn in a day.</p>

<p style='text-align:justify;'>Other indicators include the mean of the distribution, the mean of the bottom 40% of the distribution, an inequality measure corresponding to the Prosperity Gap— *(PG) Inequality* —measure, and headcount poverty at \$2.15, \$3.65, and \$6.85 a day. (PG) Inequality is the average factor by which incomes need to be multiplied to bring everyone in the society to the mean income of that society. The dashboard can be used to compare the measures of a country, region, or the world across time or between each other.</p>

<p style='text-align:justify;'>For more details on the Prosperity Gap, see [this blog on its technical properties](https://blogs.worldbank.org/impactevaluations/can-we-have-welfare-index-easy-understand-also-distribution-sensitive), another [blog on how it measures shared prosperity](https://blogs.worldbank.org/developmenttalk/prosperity-gap-proposed-new-indicator-monitor-shared-prosperity), as well as the [technical paper](https://documents.worldbank.org/en/publication/documents-reports/documentdetail/099934305302318791/idu0325015fc0a4d6046420afe405cb6b6a87b0b).</p>

<p style='text-align:justify;'>The underlying data is based on the same household surveys used in the [Poverty and Inequality Platform (PIP)](https://pip.worldbank.org/home) to report global poverty by the World Bank. The estimates in this dashboard are calculated using 1000-point binned distribution derived from the country-level household survey unit record data or grouped data. It is important to note that these estimates are preliminary, as they are estimated on a grouped version of the income distributions instead of the micro data directly. Furthermore, since the Prosperity Gap is sensitive to low values of consumption, additional analytical work is being done to refine an appropriate censoring threshold (currently set at $0.50 per day). Finally, when survey data is missing, the poverty estimates reported in PIP are based on interpolations and extrapolations of the available surveys which requires [additional assumptions](https://datanalytics.worldbank.org/PIP-Methodology/). The regional and global estimates of the Prosperity Gap reported in this dashboard utilize the interpolated country data following the same [methodology](https://datanalytics.worldbank.org/PIP-Methodology/) as PIP. A version of the 1000-point lineup-binned dataset is described in [Mahler ⓡ  al (2022)](https://documents.worldbank.org/en/publication/documents-reports/documentdetail/099250510052241154/idu01d94e70603dc804f990b6130751d75dccb52).</p>

<p style='text-align:justify;'>When plotting country trends from survey data, any breaks in the trends implies that the surveys are incomparable, for example due to changes in questionnaire design. The visualization of changes over time only includes countries that have a [comparable survey spell](https://datanalytics.worldbank.org/PIP-Methodology/welfareaggregate.html#comparability) over the selected period. </p>

<p style='text-align:justify;'>The term country, used interchangeably with economy, does not imply political independence but refers to any territory for which authorities report separate social or economic statistics. </p>

<p style='text-align:justify;'>Please cite the data as:  “Kraay ⓡ  al (2023) updated using Poverty and Inequality Platform (version 20230919_2017).” .</p>


### Definitions {#Definitions}

<span class="underline">Indicators:</span>

\newline
<p style='text-align:justify;'> *Prosperity Gap* - the average factor by which incomes need to be multiplied to bring everyone in the society to the prosperity standard of $25 daily income expressed in 2017 PPPs. </p>

<p style='text-align:justify;'> *Mean* - the daily per person mean income of the whole distribution expressed in 2017 PPPs. </p>

<p style='text-align:justify;'> *Mean of the bottom 40\%* - the daily per person mean income of the bottom 40% of the distribution expressed in 2017 PPPs.</p>

<p style='text-align:justify;'> *Prosperity Gap, Inequality (PG Inequality)* - the average factor by which incomes need to be multiplied to bring everyone in the society to the mean income of that society..</p>


<span class="underline">Other variables:</span>

\newline

<p style='text-align:justify;'>

The *Year* variable is the starting year of the household survey. In some countries, the data collection spans multiple years. When looking at changes over time, users can select *circa years* (i.e., a window around the chosen year). This increases the sample of countries available, since not all countries have annual household surveys, as explained in more detail on the chart page.</p>

<p style='text-align:justify;'>Countries can also be grouped by *region*. The dashboard uses PIP’s [regional definition](https://datanalytics.worldbank.org/PIP-Methodology/lineupestimates.html#regionsandcountries) which differs from the regional classifications used by the World Bank. Some high-income economies are excluded from the geographical regions and are included as a separate group referred to as “other high income”.</p>



